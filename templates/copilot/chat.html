{% extends "base.html" %}

{% block title %}AI Copilot - Mina{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/copilot.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/copilot-calm-motion.css') }}">
<!-- Highlight.js for code syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
/* Code block styling */
.message-content pre {
    background: var(--color-bg-subtle);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    overflow-x: auto;
    margin: var(--space-3) 0;
    border: 1px solid var(--color-border);
}

.message-content code {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
}

.message-content pre code {
    background: transparent;
    padding: 0;
    border-radius: 0;
}

.message-content code:not(pre code) {
    background: var(--color-bg-subtle);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    color: var(--color-primary);
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) var(--space-3);
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid var(--color-border);
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    margin-bottom: -1px;
}

.code-language {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    font-weight: 600;
}

.copy-code-btn {
    padding: var(--space-1) var(--space-2);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
    cursor: pointer;
    font-size: var(--text-xs);
    transition: all 0.2s;
}

.copy-code-btn:hover {
    background: var(--color-bg);
    color: var(--color-text);
}

.copy-code-btn.copied {
    color: var(--color-success);
    border-color: var(--color-success);
}

/* Voice input button */
.voice-btn {
    padding: var(--space-3);
    background: var(--color-glass);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text);
}

.voice-btn:hover {
    background: var(--color-bg);
    border-color: var(--color-primary);
}

.voice-btn.listening {
    background: var(--color-error);
    border-color: var(--color-error);
    color: white;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.voice-btn.processing {
    background: var(--color-warning);
    border-color: var(--color-warning);
    color: white;
}

.voice-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Smart Chips Styling */
.calm-chip {
    position: relative;
    overflow: hidden;
}

.calm-chip::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.calm-chip:active::after {
    width: 300px;
    height: 300px;
}

/* Streaming Message Styling */
.streaming-message .message-avatar {
    animation: calm-pulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

.section-container {
    margin-bottom: var(--space-4);
}

.section-header {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: var(--space-2);
    text-transform: capitalize;
}

/* Calm Animations */
@keyframes calm-pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.05);
    }
}

.calm-slide-in {
    animation: calm-slide-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes calm-slide-in {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.calm-fade-in {
    animation: calm-fade-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes calm-fade-in {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Lifecycle Status Indicator */
.lifecycle-status {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: var(--color-glass);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-primary);
    animation: status-pulse 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

@keyframes status-pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.5;
        transform: scale(1.2);
    }
}

#lifecycle-event-text {
    color: var(--color-text-secondary);
    font-weight: 500;
}

/* Update header to flex layout */
.copilot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
</style>
{% endblock %}

{% block content %}
<div class="copilot-workspace">
    <!-- Left Sidebar: Context & Quick Actions -->
    <aside class="copilot-sidebar">
        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h2 class="font-semibold mb-4">Context</h2>
            <select class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                <option value="all">All Meetings</option>
                <option value="recent">Recent Meetings</option>
                <option value="today">Today's Meetings</option>
                <option value="week">This Week</option>
            </select>
        </div>

        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h3 class="text-sm font-semibold mb-3 text-tertiary">Quick Actions</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                <button class="quick-action-btn" data-prompt="What decisions were made today?">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Today's Decisions
                </button>
                <button class="quick-action-btn" data-prompt="Show me all overdue tasks">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Overdue Tasks
                </button>
                <button class="quick-action-btn" data-prompt="Summarize this week's meetings">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Weekly Summary
                </button>
                <button class="quick-action-btn" data-prompt="What are the key risks identified?">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Key Risks
                </button>
            </div>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: var(--space-6);">
            <h3 class="text-sm font-semibold mb-3 text-tertiary">Recent Conversations</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Q3 Budget Discussion</p>
                    <p class="text-xs text-tertiary">2 hours ago</p>
                </div>
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Weekly Task Review</p>
                    <p class="text-xs text-tertiary">Yesterday</p>
                </div>
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Product Roadmap Query</p>
                    <p class="text-xs text-tertiary">2 days ago</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Center: Chat Interface -->
    <main class="copilot-main">
        <div class="copilot-header">
            <div>
                <h1 class="copilot-title text-2xl font-bold mb-1">AI Copilot</h1>
                <p class="text-sm text-secondary">Ask questions about your meetings, tasks, and insights</p>
            </div>
            <!-- Lifecycle Status Indicator -->
            <div id="lifecycle-status" class="lifecycle-status" style="display: none;">
                <div class="status-indicator"></div>
                <span id="lifecycle-event-text" class="text-xs"></span>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages-container">
            <!-- Welcome Message -->
            <div class="message-assistant">
                <div class="message-avatar">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div class="message-content">
                    <p class="mb-2">Hello! I'm your AI Copilot for Mina. I can help you:</p>
                    <ul class="text-sm" style="list-style: disc; margin-left: var(--space-5); display: flex; flex-direction: column; gap: var(--space-1);">
                        <li>Find information from your meetings and transcripts</li>
                        <li>Summarize discussions and extract key decisions</li>
                        <li>Manage tasks and track action items</li>
                        <li>Identify risks, blockers, and follow-ups</li>
                    </ul>
                    <p class="mt-3 text-sm text-secondary">Try asking "What's due today?" or use a quick action from the sidebar.</p>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <!-- Smart Chips (Predictive Actions from Backend) -->
            <div id="smart-chips-container" class="mb-3" style="display: none;">
                <div id="smart-chips" class="calm-animate" style="display: flex; gap: var(--space-2); flex-wrap: wrap;"></div>
            </div>
            
            <!-- Suggested Prompts -->
            <div id="suggested-prompts" class="mb-3" style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                <button class="prompt-chip" data-prompt="What's due today?">What's due today?</button>
                <button class="prompt-chip" data-prompt="Summarize yesterday's meetings">Summarize yesterday</button>
                <button class="prompt-chip" data-prompt="Show action items">Show action items</button>
            </div>

            <form id="chat-form" style="display: flex; gap: var(--space-2); align-items: end;">
                <button type="button" id="voice-btn" class="voice-btn" title="Voice input">
                    <svg id="mic-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </button>
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <textarea 
                        id="chat-input" 
                        placeholder="Ask about your meetings, decisions, or action items..." 
                        rows="1"
                        class="w-full p-3"
                        style="max-height: 120px;"
                    ></textarea>
                </div>
                <button type="submit" class="chat-send-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </form>
        </div>
    </main>

    <!-- Right Sidebar: Insights & Actions -->
    <aside class="copilot-insights">
        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h2 class="font-semibold mb-4">Smart Insights</h2>
            <div class="insight-card" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--color-primary); padding: var(--space-3); border-radius: var(--radius-md);">
                <p class="text-sm font-medium mb-1">3 overdue tasks</p>
                <p class="text-xs text-secondary">From meetings this week</p>
            </div>
        </div>

        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h3 class="text-sm font-semibold mb-3">Quick Stats</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-tertiary">Meetings Today</span>
                        <span class="font-semibold">5</span>
                    </div>
                    <div class="h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-primary" style="width: 80%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-tertiary">Tasks Completed</span>
                        <span class="font-semibold">12/15</span>
                    </div>
                    <div class="h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-success" style="width: 80%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding: var(--space-6);">
            <h3 class="text-sm font-semibold mb-3">Suggested Actions</h3>
            <div id="action-buttons" style="display: flex; flex-direction: column; gap: var(--space-2);">
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Create Task from Chat
                </button>
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Add to Calendar
                </button>
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    Share Insights
                </button>
            </div>
        </div>
    </aside>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/copilot-streaming.js') }}" nonce="{{ g.csp_nonce }}"></script>

<script nonce="{{ g.csp_nonce }}">
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const chatMessages = document.getElementById('chat-messages');
const suggestedPrompts = document.getElementById('suggested-prompts');
const smartChipsContainer = document.getElementById('smart-chips-container');
const smartChips = document.getElementById('smart-chips');

// Initialize CROWNâ¹ Copilot Streaming Client
let copilotClient = null;
let currentStreamingMessage = null;
let currentSection = 'summary';

// Initialize WebSocket connection
document.addEventListener('DOMContentLoaded', () => {
    copilotClient = new CopilotStreamingClient();
    
    // Setup callbacks
    copilotClient.onBootstrapComplete = (context) => {
        console.log('[UI] Bootstrap complete with context:', context);
    };
    
    copilotClient.onStreamToken = (token, section) => {
        appendTokenToStream(token, section || 'summary');
    };
    
    copilotClient.onStreamSection = (sectionName, content) => {
        startNewSection(sectionName);
    };
    
    copilotClient.onStreamComplete = (message, metrics) => {
        finalizeStreamingMessage();
        console.log('[UI] Stream complete:', metrics);
    };
    
    copilotClient.onError = (errorData) => {
        console.error('[UI] Copilot error:', errorData);
        addErrorMessage(errorData.error || errorData.message || 'An error occurred');
    };
    
    // Listen for chips_generated event
    copilotClient.socket.on('copilot_chips_generated', (data) => {
        console.log('[UI] Chips received:', data);
        displaySmartChips(data.chips);
    });
    
    // Listen for all lifecycle events and update status indicator
    window.addEventListener('copilot:lifecycle', (event) => {
        const { event: eventName, data } = event.detail;
        updateLifecycleStatus(eventName, data);
    });
    
    // Bootstrap the copilot
    copilotClient.bootstrap({{ current_user.workspace_id if current_user.workspace_id else 'null' }});
});

// Auto-resize textarea
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Send message via WebSocket streaming
function sendMessage(message) {
    if (!message.trim() || !copilotClient || !copilotClient.connected) {
        if (!copilotClient || !copilotClient.connected) {
            addErrorMessage('Not connected. Please wait...');
        }
        return;
    }

    addUserMessage(message);
    chatInput.value = '';
    chatInput.style.height = 'auto';
    
    hideSuggestedPrompts();
    hideSmartChips();
    
    // Start streaming message container
    currentStreamingMessage = startStreamingMessage();
    currentSection = 'summary';
    
    // Send query via WebSocket
    copilotClient.sendQuery(message, {});
}

// Display smart chips from backend
function displaySmartChips(chips) {
    if (!chips || chips.length === 0) return;
    
    smartChips.innerHTML = '';
    
    chips.forEach(chip => {
        const chipEl = document.createElement('button');
        chipEl.className = 'prompt-chip calm-chip calm-animate';
        chipEl.textContent = chip.text;
        chipEl.dataset.prompt = chip.action_data?.prompt || chip.text;
        chipEl.dataset.chipType = chip.chip_type;
        
        chipEl.addEventListener('click', () => {
            sendMessage(chipEl.dataset.prompt);
        });
        
        smartChips.appendChild(chipEl);
    });
    
    smartChipsContainer.style.display = 'block';
    // Trigger calm animation
    requestAnimationFrame(() => {
        smartChipsContainer.classList.add('calm-fade-in');
    });
}

function hideSmartChips() {
    smartChipsContainer.style.display = 'none';
    smartChipsContainer.classList.remove('calm-fade-in');
}

// Update lifecycle status indicator
const lifecycleStatus = document.getElementById('lifecycle-status');
const lifecycleEventText = document.getElementById('lifecycle-event-text');

const LIFECYCLE_MESSAGES = {
    'copilot_bootstrap': 'Initializing...',
    'context_rehydrate': 'Loading context',
    'chips_generate': 'Generating suggestions',
    'idle_listen': 'Listening',
    'query_detect': 'Processing query',
    'context_merge': 'Analyzing context',
    'reasoning_stream': 'Thinking...',
    'response_commit': 'Finalizing response',
    'action_trigger': 'Executing action',
    'cross_surface_sync': 'Syncing data',
    'context_retrain': 'Learning from interaction',
    'idle_prompt': 'Suggesting next steps'
};

function updateLifecycleStatus(eventName, data) {
    const message = LIFECYCLE_MESSAGES[eventName] || eventName;
    
    lifecycleEventText.textContent = message;
    lifecycleStatus.style.display = 'flex';
    lifecycleStatus.classList.add('calm-fade-in');
    
    // Hide status after reasoning_stream starts (let streaming UI take over)
    if (eventName === 'reasoning_stream' || eventName === 'response_commit') {
        setTimeout(() => {
            lifecycleStatus.style.display = 'none';
            lifecycleStatus.classList.remove('calm-fade-in');
        }, 2000);
    }
}

// Start a new streaming message container
function startStreamingMessage() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-assistant streaming-message calm-animate';
    messageDiv.innerHTML = `
        <div class="message-avatar calm-pulse">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </div>
        <div class="message-content">
            <div class="section-container section-summary"></div>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    return messageDiv;
}

// Append token to current streaming message
function appendTokenToStream(token, section) {
    if (!currentStreamingMessage) return;
    
    const contentDiv = currentStreamingMessage.querySelector('.message-content');
    let sectionContainer = contentDiv.querySelector(`.section-${section}`);
    
    if (!sectionContainer) {
        sectionContainer = document.createElement('div');
        sectionContainer.className = `section-container section-${section}`;
        contentDiv.appendChild(sectionContainer);
    }
    
    // Append token with calm typing effect
    const textNode = document.createTextNode(token);
    sectionContainer.appendChild(textNode);
    
    scrollToBottom();
}

// Start a new section in the streaming response
function startNewSection(sectionName) {
    if (!currentStreamingMessage) return;
    
    currentSection = sectionName;
    const contentDiv = currentStreamingMessage.querySelector('.message-content');
    
    let sectionContainer = contentDiv.querySelector(`.section-${sectionName}`);
    if (!sectionContainer) {
        sectionContainer = document.createElement('div');
        sectionContainer.className = `section-container section-${sectionName} calm-slide-in`;
        
        // Add section header
        const header = document.createElement('h4');
        header.className = 'section-header';
        header.textContent = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
        sectionContainer.appendChild(header);
        
        contentDiv.appendChild(sectionContainer);
    }
}

// Finalize streaming message (remove pulsing, process markdown)
function finalizeStreamingMessage() {
    if (!currentStreamingMessage) return;
    
    // Remove streaming indicators
    currentStreamingMessage.classList.remove('streaming-message');
    const avatar = currentStreamingMessage.querySelector('.message-avatar');
    if (avatar) {
        avatar.classList.remove('calm-pulse');
    }
    
    // Process markdown in each section
    const sections = currentStreamingMessage.querySelectorAll('.section-container');
    sections.forEach(section => {
        const rawText = section.textContent;
        section.innerHTML = processMarkdown(rawText);
    });
    
    currentStreamingMessage = null;
    scrollToBottom();
}

function addUserMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-user';
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>
        <div class="message-content">${escapeHtml(text)}</div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function processMarkdown(text) {
    let processed = text;
    
    // Process code blocks with language tag
    processed = processed.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        const language = lang || 'plaintext';
        const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
        let highlighted = code;
        
        // Apply syntax highlighting if highlight.js is available
        if (typeof hljs !== 'undefined') {
            try {
                if (lang && hljs.getLanguage(lang)) {
                    highlighted = hljs.highlight(code.trim(), { language: lang }).value;
                } else {
                    highlighted = hljs.highlightAuto(code.trim()).value;
                }
            } catch (e) {
                highlighted = escapeHtml(code.trim());
            }
        } else {
            highlighted = escapeHtml(code.trim());
        }
        
        return `
            <div class="code-block" style="margin: var(--space-3) 0;">
                <div class="code-header">
                    <span class="code-language">${language}</span>
                    <button class="copy-code-btn" onclick="copyCode('${codeId}')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Copy
                    </button>
                </div>
                <pre><code id="${codeId}" class="language-${language}">${highlighted}</code></pre>
            </div>
        `;
    });
    
    // Process inline code
    processed = processed.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Process bold
    processed = processed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // Process italic
    processed = processed.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // Process bullet lists
    processed = processed.replace(/^\- (.+)$/gm, '<li>$1</li>');
    processed = processed.replace(/(<li>.*<\/li>)/s, '<ul style="margin-left: var(--space-5); list-style: disc;">$1</ul>');
    
    // Process numbered lists
    processed = processed.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
    
    // Process line breaks
    processed = processed.replace(/\n\n/g, '</p><p>');
    
    return processed;
}

function copyCode(codeId) {
    const codeElement = document.getElementById(codeId);
    if (codeElement) {
        const text = codeElement.textContent;
        navigator.clipboard.writeText(text).then(() => {
            const btn = event.target.closest('.copy-code-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('copied');
            }, 2000);
        });
    }
}

function addAssistantMessage(response) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-assistant';
    
    let html = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </div>
        <div class="message-content">
            <p>${processMarkdown(response.text)}</p>
    `;
    
    if (response.citations && response.citations.length > 0) {
        html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-3);">';
        response.citations.forEach(citation => {
            html += `
                <span class="citation-badge">
                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    ${escapeHtml(citation.title)}
                </span>
            `;
        });
        html += '</div>';
    }
    
    html += '</div>';
    messageDiv.innerHTML = html;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function addLoadingMessage() {
    const id = 'loading-' + Date.now();
    const messageDiv = document.createElement('div');
    messageDiv.id = id;
    messageDiv.className = 'loading-message message-assistant';
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </div>
        <div class="message-content">
            <div style="display: flex; align-items: center; gap: var(--space-2);">
                <span>Thinking</span>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    return id;
}

function removeLoadingMessage(id) {
    const element = document.getElementById(id);
    if (element) element.remove();
}

function addErrorMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-assistant';
    messageDiv.innerHTML = `
        <div class="message-avatar" style="background: var(--color-error);">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <div class="message-content" style="border-color: var(--color-error);">
            <p style="color: var(--color-error);">${escapeHtml(text)}</p>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function hideSuggestedPrompts() {
    suggestedPrompts.style.display = 'none';
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Event Listeners
chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    sendMessage(chatInput.value);
});

document.querySelectorAll('.quick-action-btn, .prompt-chip').forEach(btn => {
    btn.addEventListener('click', () => {
        const prompt = btn.dataset.prompt || btn.textContent;
        sendMessage(prompt);
    });
});

// Enter to send, Shift+Enter for new line
chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(chatInput.value);
    }
});

// ============ Web Speech API for Voice Input ============
const voiceBtn = document.getElementById('voice-btn');
let recognition;
let isListening = false;

// Check if browser supports Web Speech API
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    // Configure recognition
    recognition.continuous = false;  // Stop after one phrase
    recognition.interimResults = true;  // Show interim results
    recognition.lang = 'en-US';  // Default language
    
    // When recognition starts
    recognition.onstart = () => {
        isListening = true;
        voiceBtn.classList.add('listening');
        voiceBtn.title = 'Listening... Click to stop';
        chatInput.placeholder = 'ðŸŽ¤ Listening...';
    };
    
    // When recognition ends
    recognition.onend = () => {
        isListening = false;
        voiceBtn.classList.remove('listening', 'processing');
        voiceBtn.title = 'Voice input';
        if (!chatInput.value) {
            chatInput.placeholder = 'Ask about your meetings, decisions, or action items...';
        }
    };
    
    // Handle recognition results
    recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        // Update textarea with results
        if (finalTranscript) {
            chatInput.value = finalTranscript.trim();
            voiceBtn.classList.remove('listening');
            voiceBtn.classList.add('processing');
            
            // Auto-resize textarea
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            
            // Auto-send after a short delay (optional)
            setTimeout(() => {
                if (chatInput.value.trim()) {
                    sendMessage(chatInput.value);
                }
            }, 500);
        } else if (interimTranscript) {
            chatInput.value = interimTranscript;
        }
    };
    
    // Handle errors
    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isListening = false;
        voiceBtn.classList.remove('listening', 'processing');
        
        let errorMessage = 'Voice input error';
        switch(event.error) {
            case 'no-speech':
                errorMessage = 'No speech detected. Please try again.';
                break;
            case 'audio-capture':
                errorMessage = 'Microphone not found. Please check your settings.';
                break;
            case 'not-allowed':
                errorMessage = 'Microphone permission denied. Please allow microphone access.';
                break;
            case 'network':
                errorMessage = 'Network error. Please check your connection.';
                break;
        }
        
        chatInput.placeholder = errorMessage;
        setTimeout(() => {
            if (!chatInput.value) {
                chatInput.placeholder = 'Ask about your meetings, decisions, or action items...';
            }
        }, 3000);
    };
    
    // Voice button click handler
    voiceBtn.addEventListener('click', () => {
        if (isListening) {
            recognition.stop();
        } else {
            // Clear any previous value
            chatInput.value = '';
            
            // Get user's language preference from localStorage if available
            const settings = JSON.parse(localStorage.getItem('copilot_settings') || '{}');
            const userLang = settings.language || 'en-US';
            recognition.lang = userLang;
            
            try {
                recognition.start();
            } catch (e) {
                console.error('Failed to start recognition:', e);
                chatInput.placeholder = 'Voice input unavailable. Please type your message.';
                setTimeout(() => {
                    chatInput.placeholder = 'Ask about your meetings, decisions, or action items...';
                }, 3000);
            }
        }
    });
} else {
    // Browser doesn't support Web Speech API
    voiceBtn.disabled = true;
    voiceBtn.title = 'Voice input not supported in this browser';
    voiceBtn.style.opacity = '0.5';
    console.warn('Web Speech API not supported in this browser');
}
</script>

<!-- Highlight.js for syntax highlighting -->
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
{% endblock %}
