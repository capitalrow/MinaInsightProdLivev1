{% extends "base.html" %}

{% block title %}AI Copilot - Mina{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/copilot.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/copilot-calm-motion.css') }}">
<!-- Highlight.js for code syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
/* Code block styling */
.message-content pre {
    background: var(--color-bg-subtle);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    overflow-x: auto;
    margin: var(--space-3) 0;
    border: 1px solid var(--color-border);
}

.message-content code {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
}

.message-content pre code {
    background: transparent;
    padding: 0;
    border-radius: 0;
}

.message-content code:not(pre code) {
    background: var(--color-bg-subtle);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    color: var(--color-primary);
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) var(--space-3);
    background: rgba(255, 255, 255, 0.05);
    border-bottom: 1px solid var(--color-border);
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    margin-bottom: -1px;
}

.code-language {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    font-weight: 600;
}

.copy-code-btn {
    padding: var(--space-1) var(--space-2);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
    cursor: pointer;
    font-size: var(--text-xs);
    transition: all 0.2s;
}

.copy-code-btn:hover {
    background: var(--color-bg);
    color: var(--color-text);
}

.copy-code-btn.copied {
    color: var(--color-success);
    border-color: var(--color-success);
}

/* Action link buttons (from markdown [text](#) patterns) */
.copilot-action-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    margin: 2px 4px 2px 0;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark, #4a4af0) 100%);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.copilot-action-link:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    filter: brightness(1.1);
}

.copilot-action-link:active {
    transform: translateY(0);
}

/* Regular links (external URLs) */
.copilot-link {
    color: var(--color-primary);
    text-decoration: underline;
    text-decoration-color: rgba(99, 102, 241, 0.3);
    text-underline-offset: 2px;
    transition: all 0.2s ease;
}

.copilot-link:hover {
    text-decoration-color: var(--color-primary);
    color: var(--color-primary-light, #818cf8);
}

/* Voice input button - Balanced with Send Button */
.voice-btn {
    width: 48px;
    height: 48px;
    min-width: 48px;
    padding: 0;
    background: linear-gradient(145deg, rgba(139, 92, 246, 0.15) 0%, rgba(99, 102, 241, 0.1) 100%);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #a78bfa;
}

.voice-btn:hover {
    background: linear-gradient(145deg, rgba(139, 92, 246, 0.25) 0%, rgba(99, 102, 241, 0.2) 100%);
    border-color: rgba(139, 92, 246, 0.5);
    color: #c4b5fd;
    transform: translateY(-1px);
}

.voice-btn.listening {
    background: linear-gradient(145deg, #ef4444 0%, #dc2626 100%);
    border-color: #ef4444;
    color: white;
    animation: voicePulse 1.5s infinite ease-in-out;
}

@keyframes voicePulse {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
    }
    50% { 
        transform: scale(1.02); 
        box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
    }
}

.voice-btn.processing {
    background: linear-gradient(145deg, #f59e0b 0%, #d97706 100%);
    border-color: #f59e0b;
    color: white;
}

.voice-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

/* Smart Chips Styling */
.calm-chip {
    position: relative;
    overflow: hidden;
}

.calm-chip::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.calm-chip:active::after {
    width: 300px;
    height: 300px;
}

/* Streaming Message Styling */
.streaming-message .message-avatar {
    animation: calm-pulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

.section-container {
    margin-bottom: var(--space-4);
}

.section-header {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: var(--space-2);
    text-transform: capitalize;
}

/* Calm Animations */
@keyframes calm-pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.05);
    }
}

.calm-slide-in {
    animation: calm-slide-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes calm-slide-in {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.calm-fade-in {
    animation: calm-fade-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes calm-fade-in {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Lifecycle Status Indicator - Styles in copilot.css */
/* Premium shimmer animation defined in main stylesheet */

/* Update header to flex layout */
.copilot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
</style>
{% endblock %}

{% block content %}
<div class="copilot-workspace">
    <!-- Left Sidebar: Context & Quick Actions -->
    <aside class="copilot-sidebar">
        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h2 class="font-semibold mb-4">Context</h2>
            <select class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                <option value="all">All Meetings</option>
                <option value="recent">Recent Meetings</option>
                <option value="today">Today's Meetings</option>
                <option value="week">This Week</option>
            </select>
        </div>

        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h3 class="text-sm font-semibold mb-3 text-tertiary">Quick Actions</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                <button class="quick-action-btn" data-prompt="What decisions were made today?">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Today's Decisions
                </button>
                <button class="quick-action-btn" data-prompt="Show me all overdue tasks">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Overdue Tasks
                </button>
                <button class="quick-action-btn" data-prompt="Summarize this week's meetings">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Weekly Summary
                </button>
                <button class="quick-action-btn" data-prompt="What are the key risks identified?">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Key Risks
                </button>
            </div>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: var(--space-6);">
            <h3 class="text-sm font-semibold mb-3 text-tertiary">Recent Conversations</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Q3 Budget Discussion</p>
                    <p class="text-xs text-tertiary">2 hours ago</p>
                </div>
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Weekly Task Review</p>
                    <p class="text-xs text-tertiary">Yesterday</p>
                </div>
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Product Roadmap Query</p>
                    <p class="text-xs text-tertiary">2 days ago</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Center: Chat Interface -->
    <main class="copilot-main">
        <div class="copilot-header">
            <div>
                <h1 class="copilot-title">AI Copilot</h1>
                <p class="text-sm text-secondary">Ask questions about your meetings, tasks, and insights</p>
            </div>
            <!-- Lifecycle Status Indicator -->
            <div id="lifecycle-status" class="lifecycle-status" style="display: none;">
                <div class="status-indicator"></div>
                <span id="lifecycle-event-text" class="text-xs"></span>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages-container">
            <!-- Dynamic Welcome Message (will be replaced by JavaScript) -->
            <div id="welcome-message" class="message-assistant calm-animate">
                <div class="message-avatar">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div class="message-content" id="welcome-content">
                    <p class="mb-2">Loading...</p>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <!-- Smart Chips (Unified - deduped) -->
            <div id="smart-chips-container" class="mb-3" style="display: none;">
                <div id="smart-chips" class="calm-animate" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
            </div>
            
            <!-- Suggested Prompts (Initial fallback, hidden once smart chips load) -->
            <div id="suggested-prompts" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
                <button class="prompt-chip" data-prompt="Show 3 overdue tasks">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Show 3 overdue tasks
                </button>
                <button class="prompt-chip" data-prompt="What's due today?">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    What's due today?
                </button>
                <button class="prompt-chip" data-prompt="Summarize yesterday's meetings">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Summarize yesterday's meetings
                </button>
            </div>

            <form id="chat-form" style="display: flex; gap: var(--space-2); align-items: end;">
                <button type="button" id="voice-btn" class="voice-btn" title="Voice input">
                    <svg id="mic-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </button>
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <textarea 
                        id="chat-input" 
                        placeholder="Ask about your meetings, decisions, or action items..." 
                        rows="1"
                        style="max-height: 150px;"
                    ></textarea>
                </div>
                <button type="submit" class="chat-send-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </form>
        </div>
    </main>

    <!-- Right Sidebar: Insights & Actions -->
    <aside class="copilot-insights">
        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h2 class="font-semibold mb-4">Smart Insights</h2>
            <div class="insight-card" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--color-primary); padding: var(--space-3); border-radius: var(--radius-md);">
                <p class="text-sm font-medium mb-1">3 overdue tasks</p>
                <p class="text-xs text-secondary">From meetings this week</p>
            </div>
        </div>

        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h3 class="text-sm font-semibold mb-3">Quick Stats</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-tertiary">Meetings Today</span>
                        <span class="font-semibold">5</span>
                    </div>
                    <div class="h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-primary" style="width: 80%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-tertiary">Tasks Completed</span>
                        <span class="font-semibold">12/15</span>
                    </div>
                    <div class="h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-success" style="width: 80%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding: var(--space-6);">
            <h3 class="text-sm font-semibold mb-3">Suggested Actions</h3>
            <div id="action-buttons" style="display: flex; flex-direction: column; gap: var(--space-2);">
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Create Task from Chat
                </button>
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Add to Calendar
                </button>
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    Share Insights
                </button>
            </div>
        </div>
    </aside>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/copilot-streaming.js') }}" nonce="{{ g.csp_nonce }}"></script>

<script nonce="{{ g.csp_nonce }}">
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const chatMessages = document.getElementById('chat-messages');
const suggestedPrompts = document.getElementById('suggested-prompts');
const smartChipsContainer = document.getElementById('smart-chips-container');
const smartChips = document.getElementById('smart-chips');

// Initialize CROWNâ¹ Copilot Streaming Client
let copilotClient = null;
let currentStreamingMessage = null;
let currentSection = 'summary';

// ============ Dynamic Greeting System (CROWNâ¹ Personalization) ============

/**
 * Generate time-of-day based greeting with activity context
 */
function generateDynamicGreeting() {
    const hour = new Date().getHours();
    const username = '{{ current_user.username if current_user.username else "there" }}';
    
    // Time-based greetings
    let greeting, icon, suggestion;
    
    if (hour >= 5 && hour < 12) {
        greeting = `Good morning, ${username}!`;
        icon = 'â˜€ï¸';
        suggestion = 'Let me help you prepare for the day ahead.';
    } else if (hour >= 12 && hour < 17) {
        greeting = `Good afternoon, ${username}!`;
        icon = 'ðŸŒ¤ï¸';
        suggestion = 'Need a quick summary of your morning meetings?';
    } else if (hour >= 17 && hour < 21) {
        greeting = `Good evening, ${username}!`;
        icon = 'ðŸŒ†';
        suggestion = 'Let me help you wrap up the day.';
    } else {
        greeting = `Hey ${username}!`;
        icon = 'ðŸŒ™';
        suggestion = 'Working late? I can help you review your day.';
    }
    
    // Day-specific context
    const dayOfWeek = new Date().getDay();
    let dayContext = '';
    
    if (dayOfWeek === 1) { // Monday
        dayContext = "Let's start the week strong. ";
    } else if (dayOfWeek === 5) { // Friday
        dayContext = "End of week - want me to summarize this week's progress? ";
    } else if (dayOfWeek === 0 || dayOfWeek === 6) { // Weekend
        dayContext = "Working on the weekend? ";
    }
    
    return {
        greeting,
        icon,
        dayContext,
        suggestion
    };
}

/**
 * Render dynamic welcome message with personalization
 */
function renderDynamicWelcome() {
    const { greeting, icon, dayContext, suggestion } = generateDynamicGreeting();
    const welcomeContent = document.getElementById('welcome-content');
    
    if (!welcomeContent) return;
    
    welcomeContent.innerHTML = `
        <p class="mb-2"><span style="font-size: 1.2em;">${icon}</span> ${greeting} I'm your AI Copilot for Mina.</p>
        <p class="text-sm mb-3">${dayContext}${suggestion}</p>
        <p class="text-sm mb-2">I can help you:</p>
        <ul class="text-sm" style="list-style: disc; margin-left: var(--space-5); display: flex; flex-direction: column; gap: var(--space-1);">
            <li>Find information from your meetings and transcripts</li>
            <li>Summarize discussions and extract key decisions</li>
            <li>Manage tasks and track action items</li>
            <li>Identify risks, blockers, and follow-ups</li>
        </ul>
        <p class="mt-3 text-sm text-secondary">Try asking "What's due today?" or use a quick action from the sidebar.</p>
    `;
    
    // Add calm entrance animation
    const welcomeMessage = document.getElementById('welcome-message');
    if (welcomeMessage) {
        welcomeMessage.classList.add('calm-fade-in');
    }
}

// Initialize WebSocket connection
document.addEventListener('DOMContentLoaded', () => {
    // Render dynamic greeting first
    renderDynamicWelcome();
    
    copilotClient = new CopilotStreamingClient();
    
    // Setup callbacks
    copilotClient.onBootstrapComplete = (context) => {
        console.log('[UI] Bootstrap complete with context:', context);
    };
    
    copilotClient.onStreamToken = (token, section) => {
        appendTokenToStream(token, section || 'summary');
    };
    
    copilotClient.onStreamSection = (sectionName, content) => {
        startNewSection(sectionName);
    };
    
    copilotClient.onStreamComplete = (message, metrics) => {
        finalizeStreamingMessage();
        console.log('[UI] Stream complete:', metrics);
    };
    
    copilotClient.onError = (errorData) => {
        console.error('[UI] Copilot error:', errorData);
        // Handle offline queue notification differently
        if (errorData.type === 'queued_offline') {
            showOfflineNotification(errorData.message);
        } else {
            addErrorMessage(errorData.error || errorData.message || 'An error occurred');
        }
    };
    
    // Handle connection status changes (offline resilience)
    copilotClient.onConnectionChange = (status) => {
        console.log('[UI] Connection status:', status);
        updateConnectionIndicator(status);
    };
    
    // Listen for chips_generated event
    copilotClient.socket.on('copilot_chips_generated', (data) => {
        console.log('[UI] Chips received:', data);
        displaySmartChips(data.chips);
    });
    
    // Listen for cross-surface sync events (CROWNâ¹ Event #10)
    copilotClient.socket.on('copilot_sync', (data) => {
        console.log('[UI] Cross-surface sync received:', data);
        handleCrossSurfaceSync(data);
    });
    
    // Listen for action completion with tick flash animation
    copilotClient.socket.on('copilot_action_result', (data) => {
        console.log('[UI] Action result:', data);
        if (data.success) {
            showActionSuccessFlash(data.action, data.result);
        }
    });
    
    // Listen for all lifecycle events and update status indicator
    window.addEventListener('copilot:lifecycle', (event) => {
        const { event: eventName, data } = event.detail;
        updateLifecycleStatus(eventName, data);
    });
    
    // Bootstrap the copilot
    copilotClient.bootstrap({{ current_user.workspace_id if current_user.workspace_id else 'null' }});
});

// Auto-resize textarea
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Send message via WebSocket streaming (with offline resilience)
function sendMessage(message) {
    if (!message.trim() || !copilotClient) {
        return;
    }
    
    addUserMessage(message);
    chatInput.value = '';
    chatInput.style.height = 'auto';
    
    hideSuggestedPrompts();
    hideSmartChips();
    
    // Start streaming message container (will be replaced if offline)
    if (copilotClient.connected) {
        currentStreamingMessage = startStreamingMessage();
        currentSection = 'summary';
    }
    
    // Send query via WebSocket (will queue if offline)
    copilotClient.sendQuery(message, {});
}

// ============ Connection Status & Offline Resilience UI ============

/**
 * Update connection indicator in UI
 */
function updateConnectionIndicator(status) {
    let indicator = document.getElementById('connection-indicator');
    
    // Create indicator if not exists
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'connection-indicator';
        indicator.style.cssText = `
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--radius-lg);
            font-size: 12px;
            z-index: 1001;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        `;
        document.body.appendChild(indicator);
    }
    
    if (status.connected) {
        indicator.className = 'connected';
        indicator.style.background = 'rgba(34, 197, 94, 0.1)';
        indicator.style.border = '1px solid var(--color-success)';
        indicator.style.color = 'var(--color-success)';
        
        if (status.queueReplayed) {
            indicator.innerHTML = `
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M5 13l4 4L19 7" stroke="currentColor" fill="none" stroke-width="2"/>
                </svg>
                <span>Synced</span>
            `;
            // Hide after 3 seconds when synced
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => indicator.remove(), 300);
            }, 3000);
        } else {
            indicator.style.opacity = '0';
            setTimeout(() => indicator.remove(), 300);
        }
    } else if (status.reconnecting) {
        indicator.className = 'reconnecting';
        indicator.style.background = 'rgba(251, 191, 36, 0.1)';
        indicator.style.border = '1px solid var(--color-warning)';
        indicator.style.color = 'var(--color-warning)';
        indicator.style.opacity = '1';
        indicator.innerHTML = `
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <span>Reconnecting (${status.attempt || 1})...</span>
        `;
    } else {
        indicator.className = 'disconnected';
        indicator.style.background = 'rgba(239, 68, 68, 0.1)';
        indicator.style.border = '1px solid var(--color-error)';
        indicator.style.color = 'var(--color-error)';
        indicator.style.opacity = '1';
        
        const queueMsg = status.queuedMessages > 0 ? ` (${status.queuedMessages} queued)` : '';
        indicator.innerHTML = `
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3"/>
            </svg>
            <span>Offline${queueMsg}</span>
        `;
    }
    
    // Add spin keyframe if not present
    if (!document.getElementById('connection-animations')) {
        const style = document.createElement('style');
        style.id = 'connection-animations';
        style.textContent = `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`;
        document.head.appendChild(style);
    }
}

/**
 * Show offline notification when message is queued
 */
function showOfflineNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'offline-notification calm-slide-in';
    notification.innerHTML = `
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; color: var(--color-warning);">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <span>${escapeHtml(message)}</span>
    `;
    
    Object.assign(notification.style, {
        position: 'fixed',
        bottom: '100px',
        left: '50%',
        transform: 'translateX(-50%)',
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        padding: '12px 20px',
        background: 'rgba(251, 191, 36, 0.1)',
        border: '1px solid var(--color-warning)',
        borderRadius: 'var(--radius-lg)',
        backdropFilter: 'blur(12px)',
        boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
        zIndex: '1000',
        fontSize: '14px',
        color: 'var(--color-text)'
    });
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('calm-fade-out');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// Display smart chips from backend (with deduplication)
function displaySmartChips(chips) {
    if (!chips || chips.length === 0) return;
    
    // Hide initial suggested prompts when smart chips load
    if (suggestedPrompts) {
        suggestedPrompts.style.display = 'none';
    }
    
    smartChips.innerHTML = '';
    
    // Deduplicate chips by text (case-insensitive)
    const seenTexts = new Set();
    const uniqueChips = chips.filter(chip => {
        const normalizedText = (chip.text || '').toLowerCase().trim();
        if (seenTexts.has(normalizedText)) return false;
        seenTexts.add(normalizedText);
        return true;
    });
    
    // Icon mapping for chip types - using currentColor for CSS control
    const chipIcons = {
        'task': '<svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>',
        'meeting': '<svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>',
        'summary': '<svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        'default': '<svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>'
    };
    
    uniqueChips.forEach(chip => {
        const chipEl = document.createElement('button');
        chipEl.className = 'prompt-chip calm-chip calm-animate';
        
        // Add icon based on chip type (safe SVG insertion)
        const iconType = chip.chip_type || 'default';
        const iconSvg = chipIcons[iconType] || chipIcons['default'];
        
        // Create icon container safely
        const iconContainer = document.createElement('span');
        iconContainer.innerHTML = iconSvg; // SVG is controlled/trusted
        iconContainer.style.display = 'flex';
        iconContainer.style.alignItems = 'center';
        chipEl.appendChild(iconContainer);
        
        // Create text span safely using textContent (XSS-safe)
        const textSpan = document.createElement('span');
        textSpan.textContent = chip.text; // Safe: textContent escapes HTML
        chipEl.appendChild(textSpan);
        
        chipEl.dataset.prompt = chip.action_data?.prompt || chip.text;
        chipEl.dataset.chipType = chip.chip_type || 'default';
        
        chipEl.addEventListener('click', () => {
            sendMessage(chipEl.dataset.prompt);
        });
        
        smartChips.appendChild(chipEl);
    });
    
    smartChipsContainer.style.display = 'block';
    // Trigger calm animation
    requestAnimationFrame(() => {
        smartChipsContainer.classList.add('calm-fade-in');
    });
}

function hideSmartChips() {
    smartChipsContainer.style.display = 'none';
    smartChipsContainer.classList.remove('calm-fade-in');
    // Show suggested prompts again when smart chips hide
    if (suggestedPrompts) {
        suggestedPrompts.style.display = 'flex';
    }
}

// Update lifecycle status indicator
const lifecycleStatus = document.getElementById('lifecycle-status');
const lifecycleEventText = document.getElementById('lifecycle-event-text');

const LIFECYCLE_MESSAGES = {
    'copilot_bootstrap': 'Initializing...',
    'context_rehydrate': 'Loading context',
    'chips_generate': 'Generating suggestions',
    'idle_listen': 'Listening',
    'query_detect': 'Processing query',
    'context_merge': 'Analyzing context',
    'reasoning_stream': 'Thinking...',
    'response_commit': 'Finalizing response',
    'action_trigger': 'Executing action',
    'cross_surface_sync': 'Syncing data',
    'context_retrain': 'Learning from interaction',
    'idle_prompt': 'Suggesting next steps'
};

function updateLifecycleStatus(eventName, data) {
    const message = LIFECYCLE_MESSAGES[eventName] || eventName;
    
    lifecycleEventText.textContent = message;
    lifecycleStatus.style.display = 'flex';
    lifecycleStatus.classList.add('calm-fade-in');
    
    // Hide status after reasoning_stream starts (let streaming UI take over)
    if (eventName === 'reasoning_stream' || eventName === 'response_commit') {
        setTimeout(() => {
            lifecycleStatus.style.display = 'none';
            lifecycleStatus.classList.remove('calm-fade-in');
        }, 2000);
    }
}

// Start a new streaming message container
function startStreamingMessage() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-assistant streaming-message calm-animate';
    messageDiv.innerHTML = `
        <div class="message-avatar calm-pulse">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </div>
        <div class="message-content">
            <div class="section-container section-summary"></div>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    return messageDiv;
}

// Append token to current streaming message
function appendTokenToStream(token, section) {
    if (!currentStreamingMessage) return;
    
    const contentDiv = currentStreamingMessage.querySelector('.message-content');
    let sectionContainer = contentDiv.querySelector(`.section-${section}`);
    
    if (!sectionContainer) {
        sectionContainer = document.createElement('div');
        sectionContainer.className = `section-container section-${section}`;
        contentDiv.appendChild(sectionContainer);
    }
    
    // Find or create the text content wrapper (separate from header)
    let textWrapper = sectionContainer.querySelector('.section-text');
    if (!textWrapper) {
        textWrapper = document.createElement('div');
        textWrapper.className = 'section-text';
        sectionContainer.appendChild(textWrapper);
    }
    
    // Append token with calm typing effect
    const textNode = document.createTextNode(token);
    textWrapper.appendChild(textNode);
    
    scrollToBottom();
}

// Start a new section in the streaming response
function startNewSection(sectionName) {
    if (!currentStreamingMessage) return;
    
    currentSection = sectionName;
    const contentDiv = currentStreamingMessage.querySelector('.message-content');
    
    let sectionContainer = contentDiv.querySelector(`.section-${sectionName}`);
    if (!sectionContainer) {
        sectionContainer = document.createElement('div');
        sectionContainer.className = `section-container section-${sectionName} calm-slide-in`;
        
        // NOTE: Headers are now rendered by markdown (### Header format)
        // No duplicate header creation - markdown processMarkdown handles it
        
        // Add text wrapper for content
        const textWrapper = document.createElement('div');
        textWrapper.className = 'section-text';
        sectionContainer.appendChild(textWrapper);
        
        contentDiv.appendChild(sectionContainer);
    }
}

// Finalize streaming message (remove pulsing, process markdown)
function finalizeStreamingMessage() {
    if (!currentStreamingMessage) return;
    
    // Remove streaming indicators
    currentStreamingMessage.classList.remove('streaming-message');
    const avatar = currentStreamingMessage.querySelector('.message-avatar');
    if (avatar) {
        avatar.classList.remove('calm-pulse');
    }
    
    // Process markdown in each section's text content (preserving headers)
    const textWrappers = currentStreamingMessage.querySelectorAll('.section-text');
    textWrappers.forEach(textWrapper => {
        const rawText = textWrapper.textContent;
        if (rawText.trim()) {
            textWrapper.innerHTML = processMarkdown(rawText);
        }
    });
    
    currentStreamingMessage = null;
    scrollToBottom();
}

function addUserMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-user';
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>
        <div class="message-content">${escapeHtml(text)}</div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function processMarkdown(text) {
    let processed = text;
    
    // Process code blocks with language tag
    processed = processed.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        const language = lang || 'plaintext';
        const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
        let highlighted = code;
        
        // Apply syntax highlighting if highlight.js is available
        if (typeof hljs !== 'undefined') {
            try {
                if (lang && hljs.getLanguage(lang)) {
                    highlighted = hljs.highlight(code.trim(), { language: lang }).value;
                } else {
                    highlighted = hljs.highlightAuto(code.trim()).value;
                }
            } catch (e) {
                highlighted = escapeHtml(code.trim());
            }
        } else {
            highlighted = escapeHtml(code.trim());
        }
        
        return `
            <div class="code-block" style="margin: var(--space-3) 0;">
                <div class="code-header">
                    <span class="code-language">${language}</span>
                    <button class="copy-code-btn" onclick="copyCode('${codeId}')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Copy
                    </button>
                </div>
                <pre><code id="${codeId}" class="language-${language}">${highlighted}</code></pre>
            </div>
        `;
    });
    
    // Process inline code
    processed = processed.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Process bold (including **text**: pattern)
    processed = processed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // Process italic (but not already processed bold markers)
    processed = processed.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
    
    // Process markdown links [text](url)
    processed = processed.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
        // For internal actions with # or empty urls, create action buttons
        if (url === '#' || url.startsWith('action:')) {
            const action = url.replace('action:', '') || text.toLowerCase().replace(/\s+/g, '_');
            return `<button class="copilot-action-link" onclick="handleCopilotAction('${action}')">${text}</button>`;
        }
        // For external URLs, create regular links
        return `<a href="${url}" class="copilot-link" target="_blank" rel="noopener noreferrer">${text}</a>`;
    });
    
    // Process bullet lists - collect all consecutive list items
    processed = processed.replace(/((?:^- .+$\n?)+)/gm, (match) => {
        const items = match.trim().split('\n').map(line => {
            const content = line.replace(/^- /, '');
            return `<li>${content}</li>`;
        }).join('');
        return `<ul style="margin-left: var(--space-5); list-style: disc; margin-top: var(--space-2);">${items}</ul>`;
    });
    
    // Process numbered lists - collect all consecutive numbered items
    processed = processed.replace(/((?:^\d+\. .+$\n?)+)/gm, (match) => {
        const items = match.trim().split('\n').map(line => {
            const content = line.replace(/^\d+\. /, '');
            return `<li>${content}</li>`;
        }).join('');
        return `<ol style="margin-left: var(--space-5); list-style: decimal; margin-top: var(--space-2);">${items}</ol>`;
    });
    
    // Clean up orphaned markdown header markers (### appearing alone without text)
    // This happens when streaming detects a section and styles it separately
    processed = processed.replace(/^#{1,3}\s*$/gm, '');  // Remove lines with only # markers
    processed = processed.replace(/^#{1,3}\s*\n/gm, ''); // Remove # markers followed by newline
    
    // Process markdown headers (### Header -> h3, ## Header -> h2, # Header -> h1)
    // Must be done before line breaks processing
    processed = processed.replace(/^### (.+)$/gm, '<h4 style="font-size: var(--text-sm); font-weight: 600; color: var(--color-primary); margin-top: var(--space-4); margin-bottom: var(--space-2); border-bottom: 1px solid var(--color-border); padding-bottom: var(--space-1);">$1</h4>');
    processed = processed.replace(/^## (.+)$/gm, '<h3 style="font-size: var(--text-base); font-weight: 600; color: var(--color-text); margin-top: var(--space-4); margin-bottom: var(--space-2);">$1</h3>');
    processed = processed.replace(/^# (.+)$/gm, '<h2 style="font-size: var(--text-lg); font-weight: 700; color: var(--color-text); margin-top: var(--space-4); margin-bottom: var(--space-3);">$1</h2>');
    
    // Process line breaks (double newline = paragraph break)
    processed = processed.replace(/\n\n/g, '<br><br>');
    
    // Process single line breaks
    processed = processed.replace(/\n/g, '<br>');
    
    return processed;
}

function copyCode(codeId) {
    const codeElement = document.getElementById(codeId);
    if (codeElement) {
        const text = codeElement.textContent;
        navigator.clipboard.writeText(text).then(() => {
            const btn = event.target.closest('.copy-code-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('copied');
            }, 2000);
        });
    }
}

function addAssistantMessage(response) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-assistant';
    
    let html = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </div>
        <div class="message-content">
            <p>${processMarkdown(response.text)}</p>
    `;
    
    if (response.citations && response.citations.length > 0) {
        html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-3);">';
        response.citations.forEach(citation => {
            html += `
                <span class="citation-badge">
                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    ${escapeHtml(citation.title)}
                </span>
            `;
        });
        html += '</div>';
    }
    
    html += '</div>';
    messageDiv.innerHTML = html;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function addLoadingMessage() {
    const id = 'loading-' + Date.now();
    const messageDiv = document.createElement('div');
    messageDiv.id = id;
    messageDiv.className = 'loading-message message-assistant';
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </div>
        <div class="message-content">
            <div style="display: flex; align-items: center; gap: var(--space-2);">
                <span>Thinking</span>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    return id;
}

function removeLoadingMessage(id) {
    const element = document.getElementById(id);
    if (element) element.remove();
}

function addErrorMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-assistant';
    messageDiv.innerHTML = `
        <div class="message-avatar" style="background: var(--color-error);">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <div class="message-content" style="border-color: var(--color-error);">
            <p style="color: var(--color-error);">${escapeHtml(text)}</p>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function hideSuggestedPrompts() {
    suggestedPrompts.style.display = 'none';
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============ Action Link Handler ============

/**
 * Handle clicks on action links generated from markdown [text](url) patterns
 * Maps action names to copilot behaviors (navigation, queries, etc.)
 */
function handleCopilotAction(action) {
    console.log('[Copilot] Action triggered:', action);
    
    const actionRoutes = {
        'view_upcoming_tasks': '/tasks?filter=upcoming',
        'review_completed_tasks': '/tasks?filter=completed',
        'view_tasks': '/tasks',
        'view_analytics': '/analytics',
        'view_calendar': '/calendar',
        'view_meetings': '/meetings',
        'schedule_meeting': '/calendar/new',
        'create_task': null // Special handling
    };
    
    // Check if it's a navigation action
    if (actionRoutes[action]) {
        window.location.href = actionRoutes[action];
        return;
    }
    
    // Special actions that trigger copilot queries
    const queryActions = {
        'show_overdue_tasks': 'Show my overdue tasks',
        'show_blockers': 'What are my current blockers?',
        'summarize_yesterday': 'Summarize yesterday\'s meetings',
        'what_decisions': 'What decisions were made recently?'
    };
    
    if (queryActions[action]) {
        // Trigger a new query
        const query = queryActions[action];
        chatInput.value = query;
        sendMessage();
        return;
    }
    
    // For create_task, show the input with a prompt
    if (action === 'create_task') {
        chatInput.value = 'Create a task: ';
        chatInput.focus();
        return;
    }
    
    // Default: navigate to tasks
    console.log('[Copilot] Unknown action, defaulting to tasks page');
    window.location.href = '/tasks';
}

// ============ Cross-Surface Sync Handlers (CROWNâ¹ Event #10) ============

/**
 * Handle cross-surface sync events from Dashboard, Tasks, Calendar, Analytics
 * Updates local state and triggers UI refresh when actions happen on other surfaces
 */
function handleCrossSurfaceSync(data) {
    const { action, result, source, timestamp } = data;
    
    console.log(`[CrossSurfaceSync] Action: ${action}, Source: ${source}`);
    
    // Update local context based on action type
    switch (action) {
        case 'create_task':
        case 'update_task':
        case 'mark_done':
        case 'delete_task':
            // Task-related sync - refresh task chips if visible
            if (result && result.task) {
                showSyncNotification(`Task ${action === 'create_task' ? 'created' : 'updated'}: ${result.task.title || 'Task'}`, 'task');
            }
            break;
            
        case 'add_to_calendar':
        case 'schedule_meeting':
            // Calendar-related sync
            showSyncNotification('Calendar updated', 'calendar');
            break;
            
        case 'analytics_refresh':
            // Analytics update
            showSyncNotification('Analytics refreshed', 'analytics');
            break;
            
        default:
            console.log(`[CrossSurfaceSync] Unhandled action: ${action}`);
    }
    
    // Dispatch custom event for other UI components to react
    window.dispatchEvent(new CustomEvent('copilot:sync', { detail: data }));
}

/**
 * Show a brief sync notification for cross-surface updates
 */
function showSyncNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = 'sync-notification calm-slide-in';
    notification.innerHTML = `
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <span>${escapeHtml(message)}</span>
    `;
    
    // Style the notification
    Object.assign(notification.style, {
        position: 'fixed',
        bottom: '100px',
        right: '24px',
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        padding: '12px 16px',
        background: 'var(--color-glass)',
        border: '1px solid var(--color-border)',
        borderRadius: 'var(--radius-lg)',
        backdropFilter: 'blur(12px)',
        boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
        zIndex: '1000',
        fontSize: '14px',
        color: 'var(--color-text)'
    });
    
    document.body.appendChild(notification);
    
    // Remove after calm animation
    setTimeout(() => {
        notification.classList.add('calm-fade-out');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

/**
 * Show action success flash with tick animation (CROWNâ¹ Tick Flash)
 */
function showActionSuccessFlash(action, result) {
    const actionLabels = {
        'create_task': 'Task created',
        'mark_done': 'Task completed',
        'update_task': 'Task updated',
        'delete_task': 'Task removed',
        'add_to_calendar': 'Added to calendar',
        'schedule_meeting': 'Meeting scheduled'
    };
    
    const label = actionLabels[action] || `Action completed: ${action}`;
    
    // Create flash notification
    const flash = document.createElement('div');
    flash.className = 'action-flash';
    flash.innerHTML = `
        <div class="flash-icon">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" 
                      d="M5 13l4 4L19 7" 
                      style="stroke-dasharray: 24; stroke-dashoffset: 24; animation: tickDraw 0.4s ease-out forwards 0.1s;"/>
            </svg>
        </div>
        <div class="flash-text">${escapeHtml(label)}</div>
    `;
    
    // Style the flash
    Object.assign(flash.style, {
        position: 'fixed',
        top: '50%',
        left: '50%',
        transform: 'translate(-50%, -50%)',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        gap: '16px',
        padding: '32px 48px',
        background: 'var(--color-glass)',
        border: '2px solid var(--color-success)',
        borderRadius: 'var(--radius-xl)',
        backdropFilter: 'blur(20px)',
        boxShadow: '0 8px 32px rgba(0, 0, 0, 0.2)',
        zIndex: '2000',
        animation: 'flashPopIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)'
    });
    
    // Style icon container
    const iconDiv = flash.querySelector('.flash-icon');
    Object.assign(iconDiv.style, {
        width: '64px',
        height: '64px',
        borderRadius: '50%',
        background: 'var(--color-success)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'white'
    });
    
    // Style text
    const textDiv = flash.querySelector('.flash-text');
    Object.assign(textDiv.style, {
        fontSize: '18px',
        fontWeight: '600',
        color: 'var(--color-text)'
    });
    
    // Add keyframe animations if not already present
    if (!document.getElementById('flash-animations')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'flash-animations';
        styleSheet.textContent = `
            @keyframes tickDraw {
                to { stroke-dashoffset: 0; }
            }
            @keyframes flashPopIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }
            @keyframes flashPopOut {
                from {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
                to {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.9);
                }
            }
        `;
        document.head.appendChild(styleSheet);
    }
    
    document.body.appendChild(flash);
    
    // Remove after animation
    setTimeout(() => {
        flash.style.animation = 'flashPopOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards';
        setTimeout(() => flash.remove(), 300);
    }, 1500);
}

// Event Listeners
chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    sendMessage(chatInput.value);
});

document.querySelectorAll('.quick-action-btn, .prompt-chip').forEach(btn => {
    btn.addEventListener('click', () => {
        const prompt = btn.dataset.prompt || btn.textContent;
        sendMessage(prompt);
    });
});

// Enter to send, Shift+Enter for new line
chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(chatInput.value);
    }
});

// ============ Web Speech API for Voice Input ============
const voiceBtn = document.getElementById('voice-btn');
let recognition;
let isListening = false;

// Check if browser supports Web Speech API
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    // Configure recognition
    recognition.continuous = false;  // Stop after one phrase
    recognition.interimResults = true;  // Show interim results
    recognition.lang = 'en-US';  // Default language
    
    // When recognition starts
    recognition.onstart = () => {
        isListening = true;
        voiceBtn.classList.add('listening');
        voiceBtn.title = 'Listening... Click to stop';
        chatInput.placeholder = 'ðŸŽ¤ Listening...';
    };
    
    // When recognition ends
    recognition.onend = () => {
        isListening = false;
        voiceBtn.classList.remove('listening', 'processing');
        voiceBtn.title = 'Voice input';
        if (!chatInput.value) {
            chatInput.placeholder = 'Ask about your meetings, decisions, or action items...';
        }
    };
    
    // Handle recognition results
    recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        // Update textarea with results
        if (finalTranscript) {
            chatInput.value = finalTranscript.trim();
            voiceBtn.classList.remove('listening');
            voiceBtn.classList.add('processing');
            
            // Auto-resize textarea
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            
            // Auto-send after a short delay (optional)
            setTimeout(() => {
                if (chatInput.value.trim()) {
                    sendMessage(chatInput.value);
                }
            }, 500);
        } else if (interimTranscript) {
            chatInput.value = interimTranscript;
        }
    };
    
    // Handle errors
    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isListening = false;
        voiceBtn.classList.remove('listening', 'processing');
        
        let errorMessage = 'Voice input error';
        switch(event.error) {
            case 'no-speech':
                errorMessage = 'No speech detected. Please try again.';
                break;
            case 'audio-capture':
                errorMessage = 'Microphone not found. Please check your settings.';
                break;
            case 'not-allowed':
                errorMessage = 'Microphone permission denied. Please allow microphone access.';
                break;
            case 'network':
                errorMessage = 'Network error. Please check your connection.';
                break;
        }
        
        chatInput.placeholder = errorMessage;
        setTimeout(() => {
            if (!chatInput.value) {
                chatInput.placeholder = 'Ask about your meetings, decisions, or action items...';
            }
        }, 3000);
    };
    
    // Voice button click handler
    voiceBtn.addEventListener('click', () => {
        if (isListening) {
            recognition.stop();
        } else {
            // Clear any previous value
            chatInput.value = '';
            
            // Get user's language preference from localStorage if available
            const settings = JSON.parse(localStorage.getItem('copilot_settings') || '{}');
            const userLang = settings.language || 'en-US';
            recognition.lang = userLang;
            
            try {
                recognition.start();
            } catch (e) {
                console.error('Failed to start recognition:', e);
                chatInput.placeholder = 'Voice input unavailable. Please type your message.';
                setTimeout(() => {
                    chatInput.placeholder = 'Ask about your meetings, decisions, or action items...';
                }, 3000);
            }
        }
    });
} else {
    // Browser doesn't support Web Speech API
    voiceBtn.disabled = true;
    voiceBtn.title = 'Voice input not supported in this browser';
    voiceBtn.style.opacity = '0.5';
    console.warn('Web Speech API not supported in this browser');
}
</script>

<!-- Highlight.js for syntax highlighting -->
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
<script nonce="{{ g.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
{% endblock %}
