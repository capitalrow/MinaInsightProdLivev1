{% extends "base.html" %}
{% block title %}{{ session.title or 'Meeting Insights' }} - Mina{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tasks.css') }}">
<style>
/* ========================================
   CROWN‚Å∫ Session Refined View - Premium Glassmorphism Design
   Aligned with Tasks/Meetings page quality standards
   ======================================== */

:root {
  /* Crown+ Session Design Tokens */
  --session-bg-primary: #0a0a0f;
  --session-bg-secondary: #12121a;
  --session-bg-tertiary: #1a1a24;
  --session-card-bg: rgba(26, 26, 36, 0.85);
  --session-card-border: rgba(255, 255, 255, 0.08);
  --session-card-hover: rgba(99, 102, 241, 0.12);
  --session-accent: #6366f1;
  --session-accent-secondary: #9333ea;
  --session-accent-glow: rgba(99, 102, 241, 0.35);
  --session-shadow-card: 0 4px 24px rgba(0, 0, 0, 0.4);
  --session-shadow-hover: 0 8px 32px rgba(99, 102, 241, 0.25);
  --session-glass-blur: blur(16px);
  --session-radius-md: 10px;
  --session-radius-lg: 14px;
  --session-radius-xl: 18px;
  --tab-transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
  --reveal-animation: fadeInUp 0.6s ease-out;
  --crown-gradient: linear-gradient(135deg, #6366f1 0%, #9333ea 50%, #6366f1 100%);
}

/* Loading Spinner for Processing State */
.loading-spinner-small {
  width: 24px;
  height: 24px;
  border: 3px solid rgba(99, 102, 241, 0.2);
  border-top-color: var(--session-accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Processing Banner Pulsing Effect */
.smart-banner[data-insights-pending="true"] {
  animation: subtle-pulse 2s ease-in-out infinite;
  border-left: 4px solid transparent;
  border-image: var(--crown-gradient) 1;
}

@keyframes subtle-pulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 20px rgba(99, 102, 241, 0.2); }
  50% { opacity: 0.9; box-shadow: 0 0 30px rgba(99, 102, 241, 0.3); }
}

/* Main Container - Multi-layer depth */
.refined-workspace {
  width: 100%;
  max-width: 1600px;
  min-height: calc(100vh - 64px);
  margin: 0 auto;
  padding: var(--space-4);
  animation: var(--reveal-animation);
  background: linear-gradient(180deg, var(--session-bg-primary) 0%, var(--session-bg-secondary) 100%);
  position: relative;
}

.refined-workspace::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 300px;
  background: radial-gradient(ellipse at 50% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 70%);
  pointer-events: none;
}

@media (min-width: 768px) {
  .refined-workspace {
    padding: var(--space-8) var(--space-6);
  }
}

/* Header Section */
.refined-header {
  margin-bottom: var(--space-6);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

@media (min-width: 768px) {
  .refined-header {
    flex-direction: row;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-4);
  }
}

.refined-header-content {
  flex: 1;
}

.refined-title {
  font-size: clamp(1.75rem, 5vw, var(--font-size-4xl));
  font-weight: var(--font-weight-bold);
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: var(--space-2);
}

/* Share Button */
.share-session-btn {
  display: inline-flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-3) var(--space-5);
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(147, 51, 234, 0.15));
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: var(--radius-lg);
  color: var(--color-text-primary);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all 0.2s var(--calm-ease-out);
  white-space: nowrap;
  flex-shrink: 0;
}

.share-session-btn:hover {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(147, 51, 234, 0.25));
  border-color: rgba(99, 102, 241, 0.5);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

.share-session-btn:active {
  transform: translateY(0);
}

.share-session-btn svg {
  width: 18px;
  height: 18px;
}

.share-toast {
  position: fixed;
  bottom: var(--space-6);
  left: 50%;
  transform: translateX(-50%);
  background: rgba(16, 185, 129, 0.95);
  color: white;
  padding: var(--space-3) var(--space-5);
  border-radius: var(--radius-lg);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  display: flex;
  align-items: center;
  gap: var(--space-2);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  z-index: 9999;
  animation: toastSlideUp 0.3s var(--calm-ease-out);
}

@keyframes toastSlideUp {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

.refined-meta {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-3);
  color: var(--color-text-secondary);
  font-size: var(--font-size-sm);
}

.refined-meta-item {
  display: flex;
  align-items: center;
  gap: var(--space-1);
}

/* Smart Banner - Crown+ Glassmorphism */
.smart-banner {
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  border: 1px solid var(--session-card-border);
  border-radius: var(--session-radius-xl);
  padding: var(--space-5);
  margin-bottom: var(--space-6);
  display: flex;
  align-items: center;
  gap: var(--space-4);
  animation: slideInFromTop 0.5s ease-out;
  box-shadow: var(--session-shadow-card);
  position: relative;
  overflow: hidden;
}

.smart-banner::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--crown-gradient);
}

.smart-banner-icon {
  font-size: 2rem;
  flex-shrink: 0;
  filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.4));
}

.smart-banner-text {
  flex: 1;
  color: var(--color-text-primary);
}

.smart-banner-title {
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-1);
  font-size: var(--font-size-base);
  background: var(--crown-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* ========================================
   CROWN‚Å∫ TAB NAVIGATION - Premium Glassmorphism
   ======================================== */

.tab-navigation {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  margin-bottom: var(--space-6);
  position: relative;
}

@media (min-width: 768px) {
  .tab-navigation {
    flex-direction: row;
    gap: var(--space-2);
    background: var(--session-card-bg);
    backdrop-filter: var(--session-glass-blur);
    border: 1px solid var(--session-card-border);
    border-radius: var(--session-radius-lg);
    padding: var(--space-2);
    box-shadow: var(--session-shadow-card);
  }
}

/* Tab Buttons - Mobile: Premium Cards */
.tab-button {
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  border: 1px solid var(--session-card-border);
  border-radius: var(--session-radius-lg);
  padding: var(--space-4);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  color: var(--color-text-secondary);
  cursor: pointer;
  position: relative;
  transition: var(--tab-transition);
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 56px;
  width: 100%;
  box-shadow: var(--session-shadow-card);
  overflow: hidden;
}

.tab-button::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: transparent;
  transition: var(--tab-transition);
}

@media (min-width: 768px) {
  .tab-button {
    background: transparent;
    border: none;
    border-radius: var(--session-radius-md);
    padding: var(--space-3) var(--space-4);
    width: auto;
    min-height: auto;
    white-space: nowrap;
    justify-content: flex-start;
    gap: var(--space-2);
    box-shadow: none;
  }
  
  .tab-button::before {
    display: none;
  }
}

/* Tab Button Content */
.tab-button-content {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.tab-button-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

@media (min-width: 768px) {
  .tab-button-icon {
    font-size: 1.25rem;
  }
}

.tab-button-label {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
}

/* Hover State - Crown+ Glow */
.tab-button:hover {
  color: var(--session-accent);
  background: var(--session-card-hover);
  border-color: rgba(99, 102, 241, 0.4);
  transform: translateX(4px);
  box-shadow: var(--session-shadow-hover);
}

.tab-button:hover::before {
  background: var(--crown-gradient);
}

@media (min-width: 768px) {
  .tab-button:hover {
    transform: none;
    background: var(--session-card-hover);
    box-shadow: 0 0 16px var(--session-accent-glow);
  }
}

/* Active State - Mobile: Premium Glow */
.tab-button.active {
  color: white;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(147, 51, 234, 0.15));
  border-color: var(--session-accent);
  transform: translateX(6px);
  box-shadow: var(--session-shadow-hover), 0 0 24px var(--session-accent-glow);
}

.tab-button.active::before {
  background: var(--crown-gradient);
}

/* Active State - Desktop: Gradient Pill */
@media (min-width: 768px) {
  .tab-button.active {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(147, 51, 234, 0.15));
    border: 1px solid rgba(99, 102, 241, 0.4);
    transform: none;
    box-shadow: 0 0 20px var(--session-accent-glow);
  }

  .tab-button.active::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 3px;
    background: var(--crown-gradient);
    border-radius: 2px;
    animation: slideInFromLeft 0.3s ease-out;
  }
}

/* Badge - Crown+ Style */
.tab-badge {
  background: var(--crown-gradient);
  color: white;
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 0.75rem;
  font-weight: var(--font-weight-bold);
  min-width: 26px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.tab-button.active .tab-badge {
  background: white;
  color: var(--session-accent);
  box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
}

.tab-badge-secondary {
  background: var(--session-bg-tertiary);
  color: var(--color-text-secondary);
}

/* Tab Content */
.tab-content {
  display: none;
  animation: contentReveal 0.5s ease-out;
}

.tab-content.active {
  display: block;
}

@keyframes contentReveal {
  from {
    opacity: 0;
    transform: translateY(12px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Tab Panels - Crown+ Glassmorphism */
.tab-panel {
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  border: 1px solid var(--session-card-border);
  border-radius: var(--session-radius-xl);
  padding: var(--space-5);
  box-shadow: var(--session-shadow-card);
  position: relative;
}

.tab-panel::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--crown-gradient);
  border-radius: var(--session-radius-xl) 0 0 var(--session-radius-xl);
}

@media (min-width: 768px) {
  .tab-panel {
    padding: var(--space-6);
  }
}

/* Transcript Tab - Premium Segments */
.segment-list {
  max-height: 70vh;
  overflow-y: auto;
  scroll-behavior: smooth;
  padding-right: var(--space-2);
}

.segment-list::-webkit-scrollbar {
  width: 6px;
}

.segment-list::-webkit-scrollbar-track {
  background: var(--session-bg-tertiary);
  border-radius: 3px;
}

.segment-list::-webkit-scrollbar-thumb {
  background: var(--session-accent);
  border-radius: 3px;
}

.segment-item {
  background: rgba(255, 255, 255, 0.02);
  padding: var(--space-4);
  border-radius: var(--session-radius-lg);
  margin-bottom: var(--space-3);
  transition: var(--tab-transition);
  border-left: 4px solid transparent;
  position: relative;
}

.segment-item:nth-child(odd) {
  animation: segmentSlideIn 0.4s ease-out backwards;
}

.segment-item:nth-child(even) {
  animation: segmentSlideIn 0.4s ease-out 0.05s backwards;
}

@keyframes segmentSlideIn {
  from {
    opacity: 0;
    transform: translateX(-12px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.segment-item:hover {
  background: var(--session-card-hover);
  border-left-color: var(--session-accent);
  transform: translateX(6px);
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
}

/* CROWN‚Å¥.6: Highlight pulse for jump-to-transcript */
.segment-item.segment-highlight-pulse {
  animation: segmentPulse 2s ease-out;
  background: rgba(99, 102, 241, 0.15);
  border-left-color: var(--color-primary);
  box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
}

@keyframes segmentPulse {
  0% {
    background: rgba(99, 102, 241, 0.3);
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
  }
  50% {
    background: rgba(99, 102, 241, 0.2);
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
  }
  100% {
    background: rgba(99, 102, 241, 0.15);
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
  }
}

.segment-header {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  margin-bottom: var(--space-2);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.segment-speaker {
  background: var(--crown-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: var(--font-weight-semibold);
}

.segment-text {
  color: var(--color-text-primary);
  line-height: 1.7;
  font-size: var(--font-size-base);
}

/* ========================================
   CROWN‚Å∫ HIGHLIGHTS TAB - Premium Cards
   ======================================== */

.highlights-grid {
  display: grid;
  gap: var(--space-5);
}

.highlight-section {
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  border: 1px solid var(--session-card-border);
  border-radius: var(--session-radius-xl);
  padding: var(--space-5);
  box-shadow: var(--session-shadow-card);
  position: relative;
  overflow: hidden;
  animation: highlightReveal 0.5s ease-out backwards;
}

.highlight-section:nth-child(1) { animation-delay: 0.1s; }
.highlight-section:nth-child(2) { animation-delay: 0.2s; }
.highlight-section:nth-child(3) { animation-delay: 0.3s; }
.highlight-section:nth-child(4) { animation-delay: 0.4s; }

@keyframes highlightReveal {
  from {
    opacity: 0;
    transform: translateY(16px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.highlight-section::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--crown-gradient);
}

.highlight-title {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-bold);
  background: var(--crown-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: var(--space-4);
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.highlight-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.highlight-item {
  background: rgba(255, 255, 255, 0.03);
  padding: var(--space-4);
  border-radius: var(--session-radius-md);
  border-left: 4px solid var(--session-accent);
  transition: var(--tab-transition);
}

.highlight-item:hover {
  background: var(--session-card-hover);
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
}

.highlight-item-text {
  color: var(--color-text-primary);
  margin-bottom: var(--space-2);
  line-height: 1.6;
}

.highlight-item-meta {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  opacity: 0.8;
}

/* ========================================
   CROWN‚Å∫ ANALYTICS TAB - Premium Metric Cards
   ======================================== */

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: var(--space-4);
  margin-bottom: var(--space-6);
}

@media (min-width: 768px) {
  .analytics-grid {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }
}

.metric-card {
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  border: 1px solid var(--session-card-border);
  border-radius: var(--session-radius-lg);
  padding: var(--space-5);
  transition: var(--tab-transition);
  position: relative;
  overflow: hidden;
  box-shadow: var(--session-shadow-card);
  animation: metricPop 0.4s ease-out backwards;
}

.metric-card:nth-child(1) { animation-delay: 0.1s; }
.metric-card:nth-child(2) { animation-delay: 0.15s; }
.metric-card:nth-child(3) { animation-delay: 0.2s; }
.metric-card:nth-child(4) { animation-delay: 0.25s; }
.metric-card:nth-child(5) { animation-delay: 0.3s; }

@keyframes metricPop {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.metric-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--crown-gradient);
}

.metric-card:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: var(--session-shadow-hover), 0 0 24px var(--session-accent-glow);
  border-color: rgba(99, 102, 241, 0.4);
}

.metric-label {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: var(--font-weight-medium);
}

.metric-value {
  font-size: clamp(2rem, 6vw, var(--font-size-4xl));
  font-weight: var(--font-weight-bold);
  background: var(--crown-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1.1;
}

.metric-unit {
  font-size: var(--font-size-base);
  color: var(--color-text-secondary);
  margin-left: var(--space-1);
  -webkit-text-fill-color: var(--color-text-secondary);
}

/* ========================================
   CROWN‚Å∫ TASKS TAB - Premium Task Cards
   ======================================== */

.task-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.task-item {
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  padding: var(--space-4);
  border-radius: var(--session-radius-lg);
  display: flex;
  align-items: start;
  gap: var(--space-3);
  transition: var(--tab-transition);
  border-left: 4px solid var(--session-accent);
  box-shadow: var(--session-shadow-card);
  animation: taskSlideIn 0.4s ease-out backwards;
}

.task-item:nth-child(1) { animation-delay: 0.05s; }
.task-item:nth-child(2) { animation-delay: 0.1s; }
.task-item:nth-child(3) { animation-delay: 0.15s; }
.task-item:nth-child(4) { animation-delay: 0.2s; }
.task-item:nth-child(5) { animation-delay: 0.25s; }

@keyframes taskSlideIn {
  from {
    opacity: 0;
    transform: translateX(-12px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.task-item:hover {
  background: var(--session-card-hover);
  transform: translateX(6px);
  box-shadow: var(--session-shadow-hover);
  border-left-color: var(--session-accent-secondary);
}

.task-checkbox {
  margin-top: 4px;
  width: 20px;
  height: 20px;
  cursor: pointer;
  flex-shrink: 0;
  accent-color: var(--session-accent);
}

.task-content {
  flex: 1;
}

.task-text {
  color: var(--color-text-primary);
  margin-bottom: var(--space-2);
  line-height: 1.6;
  font-weight: var(--font-weight-medium);
}

.task-meta {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-3);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.task-meta span {
  display: flex;
  align-items: center;
  gap: var(--space-1);
}

/* ========================================
   CROWN‚Å∫ EMPTY STATES - Animated & Premium
   ======================================== */

.empty-state {
  text-align: center;
  padding: var(--space-10) var(--space-4);
  color: var(--color-text-secondary);
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  border-radius: var(--session-radius-xl);
  border: 1px solid var(--session-card-border);
  box-shadow: var(--session-shadow-card);
  animation: emptyStateReveal 0.6s ease-out;
}

@keyframes emptyStateReveal {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: var(--space-4);
  animation: iconFloat 3s ease-in-out infinite;
  filter: drop-shadow(0 4px 12px rgba(99, 102, 241, 0.3));
}

@keyframes iconFloat {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-8px);
  }
}

.empty-state-text {
  font-size: var(--font-size-xl);
  line-height: 1.5;
  background: var(--crown-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-2);
}

/* ========================================
   CROWN‚Å∫ ENHANCED TASKS LIST - Priority Groups
   ======================================== */

.task-list-enhanced {
  display: flex;
  flex-direction: column;
  gap: var(--space-5);
}

.task-priority-section {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.priority-header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-3) var(--space-4);
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  border-radius: var(--session-radius-md);
  border: 1px solid var(--session-card-border);
  margin-bottom: var(--space-2);
}

.priority-header.priority-high {
  border-left: 4px solid #ef4444;
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), transparent);
}

.priority-header.priority-medium {
  border-left: 4px solid #f59e0b;
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
}

.priority-header.priority-low {
  border-left: 4px solid #6b7280;
  background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), transparent);
}

.priority-icon {
  font-size: 1rem;
}

.priority-label {
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-primary);
  font-size: var(--font-size-sm);
}

.priority-count {
  background: var(--session-bg-tertiary);
  color: var(--color-text-secondary);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
  margin-left: auto;
}

/* Enhanced Task Items */
.task-item-enhanced {
  background: var(--session-card-bg);
  backdrop-filter: var(--session-glass-blur);
  border: 1px solid var(--session-card-border);
  border-radius: var(--session-radius-lg);
  padding: var(--space-4);
  display: flex;
  align-items: flex-start;
  gap: var(--space-3);
  transition: var(--tab-transition);
  box-shadow: var(--session-shadow-card);
  animation: taskEnhancedSlideIn 0.4s ease-out backwards;
}

.task-item-enhanced:nth-child(2) { animation-delay: 0.05s; }
.task-item-enhanced:nth-child(3) { animation-delay: 0.1s; }
.task-item-enhanced:nth-child(4) { animation-delay: 0.15s; }
.task-item-enhanced:nth-child(5) { animation-delay: 0.2s; }
.task-item-enhanced:nth-child(n+6) { animation-delay: 0.25s; }

@keyframes taskEnhancedSlideIn {
  from {
    opacity: 0;
    transform: translateX(-12px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.task-item-enhanced.task-priority-high {
  border-left: 4px solid #ef4444;
}

.task-item-enhanced.task-priority-medium {
  border-left: 4px solid #f59e0b;
}

.task-item-enhanced.task-priority-low {
  border-left: 4px solid #6b7280;
}

.task-item-enhanced:hover {
  background: var(--session-card-hover);
  transform: translateX(6px);
  box-shadow: var(--session-shadow-hover);
}

.task-checkbox-wrapper {
  padding-top: 2px;
  flex-shrink: 0;
}

.task-checkbox-wrapper .task-checkbox {
  width: 20px;
  height: 20px;
  accent-color: var(--session-accent);
  cursor: pointer;
}

.task-content-enhanced {
  flex: 1;
  min-width: 0;
}

.task-header-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: var(--space-2);
  margin-bottom: var(--space-2);
}

.task-header-row .task-title {
  color: var(--color-text-primary);
  font-weight: var(--font-weight-medium);
  line-height: 1.5;
  flex: 1;
}

.task-confidence {
  flex-shrink: 0;
}

.confidence-indicator {
  font-size: 0.9rem;
}

.task-metadata-row {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  font-size: var(--font-size-sm);
}

.task-meta-item {
  display: inline-flex;
  align-items: center;
  gap: var(--space-1);
  padding: 2px 8px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  color: var(--color-text-secondary);
}

.task-meta-item .meta-icon {
  font-size: 0.75rem;
}

.task-meta-item .meta-text {
  font-size: var(--font-size-xs);
}

.task-due-date.overdue {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
}

.task-due-date.due-soon {
  background: rgba(245, 158, 11, 0.15);
  color: #f59e0b;
}

.due-badge {
  font-size: 0.65rem;
  padding: 1px 6px;
  border-radius: 8px;
  font-weight: var(--font-weight-semibold);
  margin-left: var(--space-1);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.overdue-badge {
  background: #ef4444;
  color: white;
}

.soon-badge {
  background: #f59e0b;
  color: white;
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInFromTop {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInFromLeft {
  from {
    transform: scaleX(0);
    transform-origin: left;
  }
  to {
    transform: scaleX(1);
  }
}

/* Progressive reveal for tabs */
.tab-button {
  opacity: 0;
  animation: fadeInUp 0.4s ease-out forwards;
}

.tab-button:nth-child(1) { animation-delay: 0.1s; }
.tab-button:nth-child(2) { animation-delay: 0.15s; }
.tab-button:nth-child(3) { animation-delay: 0.2s; }
.tab-button:nth-child(4) { animation-delay: 0.25s; }
.tab-button:nth-child(5) { animation-delay: 0.3s; }
</style>
{% endblock %}

{% block content %}
<div class="refined-workspace">
  
  <!-- Header -->
  <div class="refined-header">
    <div class="refined-header-content">
      <h1 class="refined-title">{{ session.title or 'Live Transcription Session' }}</h1>
      <div class="refined-meta">
        <div class="refined-meta-item">
          <span>üìÖ</span>
          <span>{{ session.started_at }}</span>
        </div>
        {% if session.completed_at %}
        <div class="refined-meta-item">
          <span>‚úÖ</span>
          <span>Completed {{ session.completed_at }}</span>
        </div>
        {% endif %}
        <div class="refined-meta-item">
          <span>üí¨</span>
          <span>{{ segments|length }} segments</span>
        </div>
      </div>
    </div>
    <button class="share-session-btn" id="share-session-btn">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
      </svg>
      Share Session
    </button>
  </div>
  
  <!-- Smart Banner - Context-aware based on processing state -->
  {% if insights_pending %}
  <div class="smart-banner" id="smart-banner" data-insights-pending="true">
    <div class="smart-banner-icon">
      <div class="loading-spinner-small"></div>
    </div>
    <div class="smart-banner-text">
      <div class="smart-banner-title">Processing your meeting...</div>
      <div>Your transcript is ready. AI insights are being generated (usually 5-15 seconds).</div>
    </div>
  </div>
  {% else %}
  <div class="smart-banner" id="smart-banner" data-insights-pending="false">
    <div class="smart-banner-icon">üéØ</div>
    <div class="smart-banner-text">
      <div class="smart-banner-title">Mina has generated your meeting insights</div>
      <div>Explore your transcript, highlights, analytics, and action items below.</div>
    </div>
  </div>
  {% endif %}
  
  <!-- Tab Navigation - Mobile-First Design -->
  <nav class="tab-navigation" role="tablist">
    <button class="tab-button active" data-tab="transcript" role="tab" aria-selected="true" aria-controls="transcript-tab">
      <div class="tab-button-content">
        <span class="tab-button-icon">üìù</span>
        <span class="tab-button-label">Transcript</span>
      </div>
      <span class="tab-badge">{{ segments|length }}</span>
    </button>
    <button class="tab-button" data-tab="highlights" role="tab" aria-selected="false" aria-controls="highlights-tab">
      <div class="tab-button-content">
        <span class="tab-button-icon">‚≠ê</span>
        <span class="tab-button-label">Highlights</span>
      </div>
      {% if summary %}
      <span class="tab-badge">{{ (summary.actions|length + summary.decisions|length + summary.risks|length) if summary else 0 }}</span>
      {% endif %}
    </button>
    <button class="tab-button" data-tab="analytics" role="tab" aria-selected="false" aria-controls="analytics-tab">
      <div class="tab-button-content">
        <span class="tab-button-icon">üìä</span>
        <span class="tab-button-label">Analytics</span>
      </div>
    </button>
    <button class="tab-button" data-tab="tasks" role="tab" aria-selected="false" aria-controls="tasks-tab">
      <div class="tab-button-content">
        <span class="tab-button-icon">‚úÖ</span>
        <span class="tab-button-label">Tasks</span>
      </div>
      {% if tasks and tasks|length > 0 %}
      <span class="tab-badge">{{ tasks|length }}</span>
      {% endif %}
    </button>
  </nav>
  
  <!-- Transcript Tab -->
  <div id="transcript-tab" class="tab-content active" role="tabpanel" aria-labelledby="transcript-button">
    <div class="tab-panel">
      <h2 style="margin-bottom: var(--space-4); color: var(--color-primary);">Full Transcript</h2>
      {% if segments %}
      <div class="segment-list" id="segment-list">
        {% for segment in segments %}
        <div class="segment-item" 
             id="segment-{{ segment.id if segment.id else loop.index }}"
             data-segment-id="{{ segment.id if segment.id else loop.index }}"
             data-start-ms="{{ segment.start_ms or 0 }}"
             data-end-ms="{{ segment.end_ms or 0 }}">
          <div class="segment-header">
            {% if segment.speaker_id %}
            <span class="segment-speaker">{{ segment.speaker_id }}</span>
            {% endif %}
            {% if segment.start_ms %}
            <span class="segment-timestamp" data-ms="{{ segment.start_ms }}">{{ (segment.start_ms / 1000)|round(1) }}s</span>
            {% endif %}
            {% if segment.avg_confidence %}
            <span>Confidence: {{ (segment.avg_confidence * 100)|round }}%</span>
            {% endif %}
          </div>
          <div class="segment-text">{{ segment.text }}</div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">üìù</div>
        <div class="empty-state-text">No transcript available yet</div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Highlights Tab -->
  <div id="highlights-tab" class="tab-content" role="tabpanel" aria-labelledby="highlights-button">
    <div class="tab-panel">
      
      {# State 1: AI succeeded and generated insights #}
      {% if session.post_transcription_status == 'success' and summary %}
      <div class="highlights-grid">
        
        <!-- Summary -->
        {% if summary.summary_md %}
        <div class="highlight-section">
          <h3 class="highlight-title">üìã Summary</h3>
          <div style="color: var(--color-text-primary); line-height: 1.6;">
            {{ summary.summary_md|safe }}
          </div>
        </div>
        {% endif %}
        
        <!-- Actions -->
        {% if summary.actions %}
        <div class="highlight-section">
          <h3 class="highlight-title">üéØ Action Items</h3>
          <div class="highlight-list">
            {% for action in summary.actions %}
            <div class="highlight-item">
              <div class="highlight-item-text">{{ action.text }}</div>
              <div class="highlight-item-meta">
                {% if action.owner %}Owner: {{ action.owner }}{% endif %}
                {% if action.due %} ‚Ä¢ Due: {{ action.due }}{% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- Decisions -->
        {% if summary.decisions %}
        <div class="highlight-section">
          <h3 class="highlight-title">‚úÖ Decisions</h3>
          <div class="highlight-list">
            {% for decision in summary.decisions %}
            <div class="highlight-item">
              <div class="highlight-item-text">{{ decision.text }}</div>
              {% if decision.impact %}
              <div class="highlight-item-meta">Impact: {{ decision.impact }}</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <!-- Risks -->
        {% if summary.risks %}
        <div class="highlight-section">
          <h3 class="highlight-title">‚ö†Ô∏è Risks</h3>
          <div class="highlight-list">
            {% for risk in summary.risks %}
            <div class="highlight-item">
              <div class="highlight-item-text">{{ risk.text }}</div>
              {% if risk.mitigation %}
              <div class="highlight-item-meta">Mitigation: {{ risk.mitigation }}</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {# Show message if AI succeeded but found no highlights #}
        {% if not (summary.summary_md or summary.actions or summary.decisions or summary.risks) %}
        <div class="empty-state">
          <div class="empty-state-icon">‚≠ê</div>
          <div class="empty-state-text">No highlights found</div>
          <p style="margin-top: var(--space-2); color: var(--color-text-secondary); max-width: 500px; margin-left: auto; margin-right: auto; font-size: var(--font-size-sm);">
            The AI analyzed your meeting but didn't identify any key highlights. This can happen with very short conversations or casual chats.
          </p>
        </div>
        {% endif %}
      </div>
      
      {# State 2: AI analysis failed #}
      {% elif session.post_transcription_status == 'failed' %}
      <div class="empty-state">
        <div class="empty-state-icon">‚ö†Ô∏è</div>
        <div class="empty-state-text">Insights temporarily unavailable</div>
        <p style="margin-top: var(--space-2); color: var(--color-text-secondary); max-width: 500px; margin-left: auto; margin-right: auto; font-size: var(--font-size-sm);">
          AI analysis encountered an error. Your transcript is safely stored and you can review it in the Transcript tab.
        </p>
      </div>
      
      {# State 3: Processing or no status yet #}
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <div class="empty-state-text">Analyzing meeting...</div>
        <p style="margin-top: var(--space-2); color: var(--color-text-secondary); max-width: 500px; margin-left: auto; margin-right: auto; font-size: var(--font-size-sm);">
          AI is generating highlights from your meeting. This usually takes just a few seconds.
        </p>
      </div>
      {% endif %}
      
    </div>
  </div>
  
  <!-- Analytics Tab -->
  <div id="analytics-tab" class="tab-content" role="tabpanel" aria-labelledby="analytics-button">
    <div class="tab-panel">
      <h2 style="margin-bottom: var(--space-4); color: var(--color-primary);">Session Analytics</h2>
      {% if analytics %}
      <div class="analytics-grid">
        <div class="metric-card">
          <div class="metric-label">Total Words</div>
          <div class="metric-value">{{ analytics.word_count }}</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Duration</div>
          <div class="metric-value">{{ (analytics.total_duration / 60)|round(1) }}<span class="metric-unit">min</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Average Confidence</div>
          <div class="metric-value">{{ (analytics.average_confidence * 100)|round }}%</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Speaking Rate</div>
          <div class="metric-value">{{ analytics.words_per_minute|round }}<span class="metric-unit">wpm</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Segments</div>
          <div class="metric-value">{{ analytics.segment_count }}</div>
        </div>
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <div class="empty-state-text">Analytics are being calculated...</div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Tasks Tab -->
  <div id="tasks-tab" class="tab-content" role="tabpanel" aria-labelledby="tasks-button">
    <div class="tab-panel">
      <h2 style="margin-bottom: var(--space-4); color: var(--color-primary);">Action Items</h2>
      
      {# State 1: Tasks found (Task model is single source of truth) #}
      {% if tasks and tasks|length > 0 %}
      
      {# Sort tasks: high priority first, then medium, then low #}
      {% set high_priority_tasks = tasks|selectattr('priority', 'equalto', 'high')|list %}
      {% set medium_priority_tasks = tasks|selectattr('priority', 'in', ['medium', 'normal'])|list %}
      {% set low_priority_tasks = tasks|selectattr('priority', 'equalto', 'low')|list %}
      {% set no_priority_tasks = tasks|rejectattr('priority')|list %}
      
      <div class="task-list-enhanced">
        {# High Priority Tasks (Pinned to top) #}
        {% if high_priority_tasks|length > 0 %}
        <div class="task-priority-section">
          <div class="priority-header priority-high">
            <span class="priority-icon">üî¥</span>
            <span class="priority-label">High Priority</span>
            <span class="priority-count">{{ high_priority_tasks|length }}</span>
          </div>
          {% for task in high_priority_tasks %}
          <div class="task-item-enhanced task-priority-high" data-task-id="{{ task.id }}">
            <div class="task-checkbox-wrapper">
              <input type="checkbox" class="task-checkbox" 
                     data-task-id="{{ task.id }}" 
                     {% if task.status == 'completed' or task.status == 'done' %}checked{% endif %}
                     aria-label="Mark task as complete">
            </div>
            <div class="task-content-enhanced">
              <div class="task-header-row">
                <div class="task-title">{{ task.title }}</div>
                {% if task.confidence_score %}
                <div class="task-confidence" title="Quality score: {{ (task.confidence_score * 100)|round }}%">
                  {% if task.confidence_score >= 0.85 %}
                  <span class="confidence-indicator confidence-high" title="High quality extraction ({{ (task.confidence_score * 100)|round }}%)">‚úÖ</span>
                  {% elif task.confidence_score >= 0.65 %}
                  <span class="confidence-indicator confidence-medium" title="Medium quality extraction ({{ (task.confidence_score * 100)|round }}%)">‚ö†Ô∏è</span>
                  {% else %}
                  <span class="confidence-indicator confidence-low" title="Lower quality extraction ({{ (task.confidence_score * 100)|round }}%)">‚ÑπÔ∏è</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              <div class="task-metadata-row">
                {% if task.due_date %}
                <span class="task-meta-item task-due-date {% if task.is_overdue %}overdue{% elif task.is_due_soon %}due-soon{% endif %}" title="Due date">
                  <span class="meta-icon">üìÖ</span>
                  <span class="meta-text">{{ task.due_date }}</span>
                  {% if task.is_overdue %}<span class="due-badge overdue-badge">Overdue</span>{% elif task.is_due_soon %}<span class="due-badge soon-badge">Due Soon</span>{% endif %}
                </span>
                {% endif %}
                {% if task.extraction_context and task.extraction_context.get('metadata_extraction', {}).get('owner_name') %}
                <span class="task-meta-item task-assignee" title="Assigned to">
                  <span class="meta-icon">üë§</span>
                  <span class="meta-text">{{ task.extraction_context['metadata_extraction']['owner_name'] }}</span>
                </span>
                {% elif task.assigned_to %}
                <span class="task-meta-item task-assignee" title="Assigned to">
                  <span class="meta-icon">üë§</span>
                  <span class="meta-text">{{ task.assigned_to.username if task.assigned_to.username else 'Assigned' }}</span>
                </span>
                {% endif %}
                {% if task.category %}
                <span class="task-meta-item task-category" title="Category">
                  <span class="meta-icon">üè∑Ô∏è</span>
                  <span class="meta-text">{{ task.category|capitalize }}</span>
                </span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        
        {# Medium Priority Tasks #}
        {% if medium_priority_tasks|length > 0 or no_priority_tasks|length > 0 %}
        <div class="task-priority-section">
          <div class="priority-header priority-medium">
            <span class="priority-icon">üü°</span>
            <span class="priority-label">Medium Priority</span>
            <span class="priority-count">{{ (medium_priority_tasks|length) + (no_priority_tasks|length) }}</span>
          </div>
          {% for task in medium_priority_tasks + no_priority_tasks %}
          <div class="task-item-enhanced task-priority-medium" data-task-id="{{ task.id }}">
            <div class="task-checkbox-wrapper">
              <input type="checkbox" class="task-checkbox" 
                     data-task-id="{{ task.id }}" 
                     {% if task.status == 'completed' or task.status == 'done' %}checked{% endif %}
                     aria-label="Mark task as complete">
            </div>
            <div class="task-content-enhanced">
              <div class="task-header-row">
                <div class="task-title">{{ task.title }}</div>
                {% if task.confidence_score %}
                <div class="task-confidence" title="Quality score: {{ (task.confidence_score * 100)|round }}%">
                  {% if task.confidence_score >= 0.85 %}
                  <span class="confidence-indicator confidence-high" title="High quality ({{ (task.confidence_score * 100)|round }}%)">‚úÖ</span>
                  {% elif task.confidence_score >= 0.65 %}
                  <span class="confidence-indicator confidence-medium" title="Medium quality ({{ (task.confidence_score * 100)|round }}%)">‚ö†Ô∏è</span>
                  {% else %}
                  <span class="confidence-indicator confidence-low" title="Lower quality ({{ (task.confidence_score * 100)|round }}%)">‚ÑπÔ∏è</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              <div class="task-metadata-row">
                {% if task.due_date %}
                <span class="task-meta-item task-due-date {% if task.is_overdue %}overdue{% elif task.is_due_soon %}due-soon{% endif %}">
                  <span class="meta-icon">üìÖ</span>
                  <span class="meta-text">{{ task.due_date }}</span>
                  {% if task.is_overdue %}<span class="due-badge overdue-badge">Overdue</span>{% elif task.is_due_soon %}<span class="due-badge soon-badge">Due Soon</span>{% endif %}
                </span>
                {% endif %}
                {% if task.extraction_context and task.extraction_context.get('metadata_extraction', {}).get('owner_name') %}
                <span class="task-meta-item task-assignee">
                  <span class="meta-icon">üë§</span>
                  <span class="meta-text">{{ task.extraction_context['metadata_extraction']['owner_name'] }}</span>
                </span>
                {% elif task.assigned_to %}
                <span class="task-meta-item task-assignee">
                  <span class="meta-icon">üë§</span>
                  <span class="meta-text">{{ task.assigned_to.username if task.assigned_to.username else 'Assigned' }}</span>
                </span>
                {% endif %}
                {% if task.category %}
                <span class="task-meta-item task-category">
                  <span class="meta-icon">üè∑Ô∏è</span>
                  <span class="meta-text">{{ task.category|capitalize }}</span>
                </span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        
        {# Low Priority Tasks #}
        {% if low_priority_tasks|length > 0 %}
        <div class="task-priority-section">
          <div class="priority-header priority-low">
            <span class="priority-icon">‚ö™</span>
            <span class="priority-label">Low Priority</span>
            <span class="priority-count">{{ low_priority_tasks|length }}</span>
          </div>
          {% for task in low_priority_tasks %}
          <div class="task-item-enhanced task-priority-low" data-task-id="{{ task.id }}">
            <div class="task-checkbox-wrapper">
              <input type="checkbox" class="task-checkbox" 
                     data-task-id="{{ task.id }}" 
                     {% if task.status == 'completed' or task.status == 'done' %}checked{% endif %}
                     aria-label="Mark task as complete">
            </div>
            <div class="task-content-enhanced">
              <div class="task-header-row">
                <div class="task-title">{{ task.title }}</div>
                {% if task.confidence_score %}
                <div class="task-confidence" title="Quality score: {{ (task.confidence_score * 100)|round }}%">
                  {% if task.confidence_score >= 0.85 %}
                  <span class="confidence-indicator confidence-high" title="High quality ({{ (task.confidence_score * 100)|round }}%)">‚úÖ</span>
                  {% elif task.confidence_score >= 0.65 %}
                  <span class="confidence-indicator confidence-medium" title="Medium quality ({{ (task.confidence_score * 100)|round }}%)">‚ÑπÔ∏è</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              <div class="task-metadata-row">
                {% if task.due_date %}
                <span class="task-meta-item task-due-date {% if task.is_overdue %}overdue{% elif task.is_due_soon %}due-soon{% endif %}">
                  <span class="meta-icon">üìÖ</span>
                  <span class="meta-text">{{ task.due_date }}</span>
                </span>
                {% endif %}
                {% if task.extraction_context and task.extraction_context.get('metadata_extraction', {}).get('owner_name') %}
                <span class="task-meta-item task-assignee">
                  <span class="meta-icon">üë§</span>
                  <span class="meta-text">{{ task.extraction_context['metadata_extraction']['owner_name'] }}</span>
                </span>
                {% elif task.assigned_to %}
                <span class="task-meta-item task-assignee">
                  <span class="meta-icon">üë§</span>
                  <span class="meta-text">{{ task.assigned_to.username if task.assigned_to.username else 'Assigned' }}</span>
                </span>
                {% endif %}
                {% if task.category %}
                <span class="task-meta-item task-category">
                  <span class="meta-icon">üè∑Ô∏è</span>
                  <span class="meta-text">{{ task.category|capitalize }}</span>
                </span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      
      {# State 2: No tasks found (with intelligent context) #}
      {% elif session.post_transcription_status == 'success' or session.post_transcription_status == 'failed' %}
      <div class="empty-state">
        <div class="empty-state-icon">‚úì</div>
        <div class="empty-state-text">No action items found</div>
        <p style="margin-top: var(--space-2); color: var(--color-text-secondary); max-width: 500px; margin-left: auto; margin-right: auto; font-size: var(--font-size-sm);">
          This was an informal discussion with no specific action items mentioned.
        </p>
      </div>
      
      {# State 3: Processing #}
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <div class="empty-state-text">Finding action items...</div>
        <p style="margin-top: var(--space-2); color: var(--color-text-secondary); max-width: 500px; margin-left: auto; margin-right: auto; font-size: var(--font-size-sm);">
          Extracting action items from your meeting. This usually takes just a few seconds.
        </p>
      </div>
      {% endif %}
    </div>
  </div>
  
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Pass session ID to tabs.js via data attribute
  document.body.setAttribute('data-session-id', '{{ session.external_id }}');
  
  // CROWN‚Å¥ Event #5: Track session_refined_load performance
  (function() {
    // Wait for page load to complete before capturing metrics
    if (document.readyState === 'complete') {
      logSessionRefinedLoad();
    } else {
      window.addEventListener('load', logSessionRefinedLoad);
    }
    
    async function logSessionRefinedLoad() {
      // Use Navigation Timing API for accurate page load metrics
      const perfData = performance.getEntriesByType('navigation')[0];
      
      let totalLoadTime;
      if (perfData) {
        // Calculate total load time from navigation start to DOM complete
        totalLoadTime = Math.round(perfData.loadEventEnd - perfData.fetchStart);
      } else {
        // Fallback for older browsers
        totalLoadTime = Math.round(performance.now());
      }
      
      // Log event to EventLedger (non-blocking)
      try {
        const response = await fetch('/sessions/api/events/refined-load', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: {{ session.id|default('null') }},
            external_session_id: '{{ session.external_id }}',
            total_load_time: totalLoadTime,
            cache_hit: false  // TODO: Implement cache tracking for session pages
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log(`üìÑ session_refined_load event logged (event_id=${result.event_id}, ${totalLoadTime}ms, sub_300ms=${result.sub_300ms})`);
        } else {
          console.warn('‚ö†Ô∏è Failed to log session_refined_load event:', response.status);
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Failed to log session_refined_load event:', error);
        // Non-blocking - continue even if event logging fails
      }
    }
  })();
  
  // Share Session functionality
  document.getElementById('share-session-btn').addEventListener('click', async function() {
    const shareUrl = window.location.href;
    const sessionTitle = '{{ session.title or "Meeting Session" | e }}';
    
    try {
      if (navigator.share) {
        await navigator.share({
          title: sessionTitle + ' - Mina',
          text: 'Check out this meeting session with insights, transcript, and action items.',
          url: shareUrl
        });
      } else {
        await navigator.clipboard.writeText(shareUrl);
        showShareToast('Link copied to clipboard');
      }
    } catch (err) {
      if (err.name !== 'AbortError') {
        try {
          await navigator.clipboard.writeText(shareUrl);
          showShareToast('Link copied to clipboard');
        } catch (clipErr) {
          console.error('Failed to copy:', clipErr);
        }
      }
    }
  });
  
  function showShareToast(message) {
    const existingToast = document.querySelector('.share-toast');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.className = 'share-toast';
    toast.innerHTML = `
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      ${message}
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'toastSlideUp 0.3s var(--calm-ease-out) reverse';
      setTimeout(() => toast.remove(), 250);
    }, 2500);
  }
  
  // CROWN+ Real-time Updates for Background Processing
  // Refreshes page when insights become ready
  (function() {
    const SESSION_ID = '{{ session.external_id }}';
    const currentStatus = '{{ session.post_transcription_status }}';
    const insightsPending = {{ 'true' if insights_pending else 'false' }};
    const segmentsSource = '{{ segments_source }}';
    
    console.log('[Session Refined] State:', { currentStatus, insightsPending, segmentsSource });
    
    // Only set up listeners if insights are still processing OR we're using live segments
    if (insightsPending || currentStatus === 'processing' || !currentStatus) {
      console.log('[Session Refined] Insights still processing, setting up real-time updates...');
      
      // Connect to Socket.IO for real-time updates
      if (typeof io !== 'undefined') {
        const socket = io({
          path: '/socket.io',
          transports: ['websocket', 'polling'],
          reconnection: true
        });
        
        socket.on('connect', () => {
          console.log('[Session Refined] Connected for real-time updates');
        });
        
        // Listen for insights completion
        socket.on('insights_generate', (data) => {
          if (data.session_id === SESSION_ID && data.status === 'completed') {
            console.log('[Session Refined] Insights ready! Refreshing page...');
            showInsightsReadyNotification();
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          }
        });
        
        // Also listen for post_transcription_reveal as fallback
        socket.on('post_transcription_reveal', (data) => {
          if (data.session_id === SESSION_ID) {
            console.log('[Session Refined] Post-transcription complete! Refreshing...');
            window.location.reload();
          }
        });
      }
      
      // Fallback: Poll for updates if WebSocket not available
      let pollAttempts = 0;
      const maxPolls = 12; // 2 minutes max (10s interval)
      
      const pollForUpdates = setInterval(() => {
        pollAttempts++;
        if (pollAttempts >= maxPolls) {
          clearInterval(pollForUpdates);
          console.log('[Session Refined] Max poll attempts reached, stopping polling');
          return;
        }
        
        fetch(`/api/sessions/${SESSION_ID}/status`)
          .then(r => r.json())
          .then(data => {
            if (data.post_transcription_status === 'success' || data.post_transcription_status === 'failed') {
              console.log('[Session Refined] Status changed to:', data.post_transcription_status);
              clearInterval(pollForUpdates);
              showInsightsReadyNotification();
              setTimeout(() => window.location.reload(), 1000);
            }
          })
          .catch(e => console.log('[Session Refined] Poll error:', e));
      }, 10000); // Poll every 10 seconds
    }
    
    function showInsightsReadyNotification() {
      const toast = document.createElement('div');
      toast.className = 'share-toast';
      toast.innerHTML = `
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Insights ready! Refreshing...
      `;
      document.body.appendChild(toast);
    }
  })();
  
  // CROWN+ Graceful Loading State Timeout Handler
  // Converts perpetual spinners to helpful empty states after 8 seconds
  (function() {
    const LOADING_TIMEOUT_MS = 8000;
    
    // Map of loading indicators (text match) to their graceful empty states
    const loadingStateReplacements = {
      'Analyzing meeting...': {
        icon: 'üìã',
        title: 'Meeting analysis not available',
        description: 'Insights for this meeting haven\'t been generated. You can still view the full transcript in the Transcript tab.'
      },
      'Analytics are being calculated...': {
        icon: 'üìä',
        title: 'Analytics not available',
        description: 'Analytics data for this meeting hasn\'t been calculated. Check the Transcript tab for meeting details.'
      },
      'Finding action items...': {
        icon: '‚úì',
        title: 'No action items available',
        description: 'Action items for this meeting haven\'t been extracted. Try reviewing the transcript for any mentioned tasks.'
      }
    };
    
    // Find and replace loading states after timeout
    setTimeout(function() {
      const emptyStates = document.querySelectorAll('.empty-state');
      
      emptyStates.forEach(function(emptyState) {
        const textEl = emptyState.querySelector('.empty-state-text');
        if (!textEl) return;
        
        const currentText = textEl.textContent.trim();
        const replacement = loadingStateReplacements[currentText];
        
        if (replacement) {
          console.log('[Session Refined] Graceful timeout: replacing "' + currentText + '" with empty state');
          
          // Animate transition
          emptyState.style.transition = 'opacity 0.3s ease-out';
          emptyState.style.opacity = '0';
          
          setTimeout(function() {
            // Update content
            const iconEl = emptyState.querySelector('.empty-state-icon');
            if (iconEl) iconEl.textContent = replacement.icon;
            textEl.textContent = replacement.title;
            
            // Update description if exists
            const descEl = emptyState.querySelector('p');
            if (descEl) {
              descEl.textContent = replacement.description;
            }
            
            // Fade back in
            emptyState.style.opacity = '1';
          }, 300);
        }
      });
    }, LOADING_TIMEOUT_MS);
  })();
  
  // CROWN‚Å¥.6 Section 7: Jump to Transcript Segment
  // Handles incoming timestamp parameter and scrolls to the relevant segment
  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    const timestampMs = parseInt(urlParams.get('t'));
    
    if (!timestampMs || isNaN(timestampMs)) return;
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      // Make sure we're on the transcript tab
      const transcriptTab = document.getElementById('transcript-tab');
      const transcriptButton = document.querySelector('[data-tab="transcript"]');
      
      if (transcriptTab && transcriptButton) {
        // Activate transcript tab
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-selected', 'false');
        });
        transcriptTab.classList.add('active');
        transcriptButton.classList.add('active');
        transcriptButton.setAttribute('aria-selected', 'true');
      }
      
      // Find the segment closest to the timestamp
      const segments = document.querySelectorAll('.segment-item[data-start-ms]');
      let targetSegment = null;
      let closestDiff = Infinity;
      
      segments.forEach(function(segment) {
        const segmentStart = parseInt(segment.dataset.startMs) || 0;
        const diff = Math.abs(segmentStart - timestampMs);
        if (diff < closestDiff) {
          closestDiff = diff;
          targetSegment = segment;
        }
      });
      
      if (targetSegment) {
        // Scroll to segment with smooth animation
        setTimeout(function() {
          targetSegment.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Add highlight pulse effect
          targetSegment.classList.add('segment-highlight-pulse');
          
          // Remove highlight after animation
          setTimeout(function() {
            targetSegment.classList.remove('segment-highlight-pulse');
          }, 3000);
        }, 300);
      }
    });
  })();
</script>
<script src="{{ url_for('static', filename='js/tabs.js') }}"></script>
{% endblock %}
