{# Task Card Macro - Reusable template for server-rendered task cards #}
{# CROWN⁴.9: 3-Tier Progressive Disclosure - Scan → Glance → Detail #}

{% macro task_card(task) %}
{# Precompute context data for efficiency #}
{% set full_quote = task.extraction_context.evidence_quote if task.extraction_context and task.extraction_context.evidence_quote else '' %}
{% set speaker = task.extraction_context.speaker if task.extraction_context and task.extraction_context.speaker else '' %}
{% set start_ms = task.transcript_span.start_ms if task.transcript_span and task.transcript_span.start_ms is not none else 0 %}
{% set has_provenance = task.extracted_by_ai and task.meeting %}
{% set has_transcript = task.meeting_id and task.transcript_span and task.transcript_span.start_ms is not none %}
{% set has_detail_content = has_provenance or has_transcript or (task.labels and task.labels|length > 0) or task.description %}

<div class="task-card{% if task.status == 'completed' %} completed{% endif %}" 
     data-task-id="{{ task.id }}"
     data-meeting-id="{{ task.meeting_id or '' }}"
     data-session-id="{{ task.session_id or '' }}"
     data-extracted-by-ai="{{ 'true' if task.extracted_by_ai else 'false' }}"
     data-status="{{ task.status|default('todo') }}"
     data-priority="{{ task.priority|default('medium')|lower }}"
     data-assigned-to="{{ task.assigned_to_id or '' }}"
     data-due-date="{{ task.due_date or '' }}"
     data-labels="{{ task.labels|tojson|escape if task.labels else '[]' }}"
     data-transcript-span="{{ task.transcript_span|tojson|escape if task.transcript_span else '{}' }}"
     data-updated-at="{{ task.updated_at.isoformat() if task.updated_at else '' }}"
     data-is-pinned="{{ 'true' if task.is_pinned else 'false' }}"
     data-has-detail="{{ 'true' if has_detail_content else 'false' }}"
     role="article"
     aria-label="Task: {{ task.title }}">
    
    {# Checkbox with enhanced touch target #}
    <div class="checkbox-wrapper">
        <input type="checkbox" 
               {% if task.status == 'completed' %}checked{% endif %} 
               class="task-checkbox" 
               data-task-id="{{ task.id }}"
               aria-label="Mark task as {% if task.status == 'completed' %}incomplete{% else %}complete{% endif %}">
    </div>
    
    <div class="task-content">
        {# TIER 1: SCAN - Always visible: Checkbox + Title + Priority dot ONLY #}
        <div class="task-primary-row task-tier-1">
            <h3 class="task-title" data-field="title">{{ task.title or 'Untitled Task' }}</h3>
            
            <div class="task-essential-meta">
                {# Priority dot (subtle indicator) - ONLY thing in Tier 1 meta #}
                <span class="priority-dot priority-{{ task.priority|default('medium')|lower }}" 
                      data-field="priority"
                      title="Priority: {{ task.priority|default('Medium')|capitalize }}"></span>
                
                {# Expand indicator for cards with detail content #}
                {% if has_detail_content %}
                <button class="task-expand-trigger" aria-label="Expand task details" title="Show details">
                    <svg class="expand-icon" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                {% endif %}
            </div>
        </div>
        
        {# TIER 2: GLANCE - Revealed on hover: Due date + Assignee #}
        <div class="task-secondary-row task-tier-2">
            {# Due date - moved from Tier 1 to Tier 2 #}
            {% if task.due_date %}
            {% set is_overdue = task.is_overdue if task.is_overdue is defined else false %}
            {% set is_due_soon = task.is_due_soon if task.is_due_soon is defined else false %}
            <span class="due-date-compact{% if is_overdue %} overdue{% elif is_due_soon %} due-soon{% endif %}" 
                  data-field="due_date"
                  title="Due {{ task.due_date.strftime('%B %d, %Y') }}">
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                </svg>
                {{ task.due_date.strftime('%b %d') }}
            </span>
            {% endif %}
            
            {# Assignee badge #}
            {% if task.assigned_to %}
            <span class="assignee-compact" data-field="assignee" title="Assigned to {{ task.assigned_to.display_name or task.assigned_to.username }}">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                {{ task.assigned_to.display_name or task.assigned_to.username }}
            </span>
            {% endif %}
            
            {# Show "more" hint if there's detail content #}
            {% if has_detail_content and not task.due_date and not task.assigned_to %}
            <span class="tier2-hint">
                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Details available</span>
            </span>
            {% endif %}
        </div>
        
        {# TIER 3: DETAIL - Revealed on expand: Labels, Provenance, Notes #}
        <div class="task-tertiary-row task-tier-3">
            {# Labels #}
            {% if task.labels and task.labels|length > 0 %}
            <div class="labels-compact" data-field="labels">
                {% for label in task.labels[:3] %}
                <span class="label-compact">{{ label }}</span>
                {% endfor %}
                {% if task.labels|length > 3 %}
                <span class="label-compact label-overflow">+{{ task.labels|length - 3 }}</span>
                {% endif %}
            </div>
            {% endif %}
            
            {# Meeting Provenance Badge #}
            {% if has_provenance %}
            <span class="provenance-compact" 
                  data-task-id="{{ task.id }}"
                  data-action="show-context-preview"
                  data-has-context="{{ 'true' if full_quote else 'false' }}"
                  data-context-quote="{{ full_quote|escape }}"
                  data-context-speaker="{{ speaker|escape }}"
                  data-context-start-ms="{{ start_ms }}"
                  data-meeting-id="{{ task.meeting_id }}"
                  data-meeting-title="{{ task.meeting.title|escape }}"
                  data-confidence="{{ task.confidence_score if task.confidence_score else 0 }}"
                  title="From meeting: {{ task.meeting.title }}{% if speaker %} - {{ speaker }}{% endif %}">
                <svg class="provenance-icon" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                </svg>
                <span>{{ task.meeting.title|truncate(15, True) }}</span>
                {% if task.confidence_score and task.confidence_score >= 0.8 %}
                <span class="confidence-dot high" title="High confidence"></span>
                {% endif %}
            </span>
            {% endif %}
            
            {# Jump to Transcript (if available) #}
            {% if has_transcript %}
            <button class="provenance-compact jump-to-transcript-btn" 
                    data-action="jump-to-transcript"
                    data-task-id="{{ task.id }}"
                    title="Jump to transcript at {{ (start_ms / 60000)|int }}:{{ ((start_ms / 1000) % 60)|int|string|truncate(2, True, '') }}">
                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <span>Transcript</span>
            </button>
            {% endif %}
            
            {# Task Description/Notes (if available) #}
            {% if task.description %}
            <div class="task-description-preview">
                <p class="description-text">{{ task.description|truncate(100, True) }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    {# Actions area - Menu trigger always present but revealed on hover #}
    <div class="task-actions">
        {# Priority badge (full version for editing) - hidden by CSS #}
        <span class="priority-badge priority-{{ task.priority|default('medium')|lower }}" 
              data-field="priority"
              title="Click to change priority">
            {{ task.priority|default('medium')|capitalize }}
        </span>
        
        <button class="task-menu-trigger" 
                data-task-id="{{ task.id }}"
                role="button"
                aria-haspopup="menu"
                aria-expanded="false"
                aria-label="Task actions menu"
                title="More actions">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="5" r="2"/>
                <circle cx="12" cy="12" r="2"/>
                <circle cx="12" cy="19" r="2"/>
            </svg>
        </button>
    </div>
</div>
{% endmacro %}

{# 
CROWN⁴.9 3-Tier Progressive Disclosure Structure:

TIER 1 - SCAN (Always visible):
- Checkbox (48×48dp touch target)
- Task title (16px, 2-line clamp)
- Priority dot (8px, color-coded)
- Expand indicator (if detail content exists)

TIER 2 - GLANCE (Revealed on hover):
- Due date (with overdue/due-soon states)
- Assignee badge
- "Details available" hint (if no date/assignee but has Tier 3 content)

TIER 3 - DETAIL (Revealed on expand click):
- Labels (max 3 + overflow count)
- Meeting provenance badge
- Jump to transcript button
- Task description/notes preview

CSS classes:
- .task-tier-1 / .task-primary-row: Always visible
- .task-tier-2 / .task-secondary-row: Hidden, revealed on .task-card:hover
- .task-tier-3 / .task-tertiary-row: Hidden, revealed on .task-card.expanded
- Mobile: Tap card to toggle .expanded class

Interaction Model:
- Desktop: Hover shows Tier 2, click expand button shows Tier 3
- Mobile: First tap shows Tier 2+3, second tap collapses
#}
