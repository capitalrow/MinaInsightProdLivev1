{% extends "base.html" %}
{% from 'dashboard/_task_card_macro.html' import task_card %}

{% block title %}Tasks - Mina{% endblock %}

{% block extra_css %}
<style>
/* CROWN⁴.6: Critical CSS for <200ms First Paint */
.tasks-container{max-width:1200px;margin:0 auto;padding:1.5rem}
.tasks-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.tasks-title{font-size:1.75rem;font-weight:700;color:var(--text-primary,#1a1a2e)}
.task-filters{display:flex;gap:0.5rem;margin-bottom:1rem}
.filter-tab{padding:0.5rem 1rem;border-radius:8px;border:none;background:var(--bg-secondary,#f5f5f7);cursor:pointer;transition:all 0.15s}
.filter-tab.active{background:var(--primary,#6366f1);color:white}
.tasks-list-container{min-height:200px}
.task-card{display:flex;align-items:flex-start;padding:1rem;background:var(--card-bg,#fff);border-radius:12px;margin-bottom:0.75rem;box-shadow:0 1px 3px rgba(0,0,0,0.08);transition:transform 0.15s,box-shadow 0.15s}
.task-card:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.task-checkbox{width:20px;height:20px;border-radius:50%;border:2px solid var(--border,#e0e0e0);margin-right:1rem;cursor:pointer;flex-shrink:0}
.task-title{font-weight:500;color:var(--text-primary,#1a1a2e);margin-bottom:0.25rem}
.task-meta{font-size:0.875rem;color:var(--text-secondary,#6b7280)}
.skeleton-pulse{animation:skeleton-pulse 1.5s ease-in-out infinite}
@keyframes skeleton-pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.task-skeleton{display:flex;align-items:center;padding:1rem;background:#fff;border-radius:12px;margin-bottom:0.75rem}
.skeleton-checkbox{width:20px;height:20px;border-radius:50%;background:#e5e7eb;margin-right:1rem}
.skeleton-content{flex:1}
.skeleton-title{height:18px;background:#e5e7eb;border-radius:4px;width:70%;margin-bottom:8px}
.skeleton-meta{height:14px;background:#e5e7eb;border-radius:4px;width:40%}
</style>
<link rel="stylesheet" href="{{ url_for('static', filename='css/tasks.css') }}?v=6">
<link rel="stylesheet" href="{{ url_for('static', filename='css/linear-inspired-animations.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/task-provenance.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/meeting-heatmap.css') }}?v=2">
<link rel="stylesheet" href="{{ url_for('static', filename='css/task-context-preview.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/meeting-intelligence-mode.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/semantic-search.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/stress-indicators.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/dev-performance-panel.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/task-completion-ux.css') }}?v=3" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/task-confirmation-modal.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/task-date-picker.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/task-priority-selector.css') }}?v=1" media="print" data-async-css>
<link rel="stylesheet" href="{{ url_for('static', filename='css/task-action-modals.css') }}?v=1" media="print" data-async-css>
<script nonce="{{ csp_nonce }}">
(function(){var a=document.querySelectorAll('link[data-async-css]');a.forEach(function(l){l.onload=function(){l.media='all'};if(l.sheet)l.media='all'})})();
</script>
{% endblock %}

{% block content %}
<div class="container tasks-container">
    <!-- Header -->
    <div class="tasks-header flex justify-between items-center">
        <div>
            <h1 class="tasks-title">Action Items</h1>
            <p class="tasks-subtitle">Track and manage tasks from your meetings</p>
        </div>
        <div class="header-actions">
            <!-- CROWN⁴.6: Stress Indicator -->
            <div id="stress-indicator" class="stress-indicator hidden">
                <div class="stress-dot"></div>
                <div class="stress-tooltip">High workload</div>
            </div>
            
            <button class="btn btn-secondary btn-generate-proposals" data-meeting-id="{{ meeting_id if meeting_id else '' }}">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                AI Proposals
            </button>
            <button id="new-task-btn" class="btn btn-primary">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Task
            </button>
        </div>
    </div>

    <!-- Offline/Status Banner -->
    <div id="connection-banner" class="connection-banner hidden">
        <span class="connection-status-icon"></span>
        <span class="connection-message"></span>
        <span class="pending-count"></span>
    </div>

    <!-- Filters - All/Active/Archived Tabs (Linear-style) -->
    <!-- CROWN⁴.6: Fixed counters to use status field (Task model has no archived_at column) -->
    <!-- Active = todo, in_progress, pending, blocked (not completed/cancelled) -->
    <!-- Archived = completed or cancelled tasks -->
    <div class="task-filters">
        <button class="filter-tab" data-filter="all">
            All
            <span class="filter-counter filter-counter-all" data-counter="all">
                {{ tasks|length if tasks else 0 }}
            </span>
        </button>
        <button class="filter-tab active" data-filter="active">
            Active
            <span class="filter-counter filter-counter-active" data-counter="active">
                {{ tasks|rejectattr('status', 'equalto', 'completed')|rejectattr('status', 'equalto', 'cancelled')|list|length if tasks else 0 }}
            </span>
        </button>
        <button class="filter-tab" data-filter="archived">
            Archived
            <span class="filter-counter filter-counter-archived" data-counter="archived">
                {% set completed_count = tasks|selectattr('status', 'equalto', 'completed')|list|length if tasks else 0 %}
                {% set cancelled_count = tasks|selectattr('status', 'equalto', 'cancelled')|list|length if tasks else 0 %}
                {{ completed_count + cancelled_count }}
            </span>
        </button>
    </div>

    <!-- Bulk Action Toolbar (appears when tasks selected) -->
    <div id="bulk-action-toolbar" class="bulk-action-toolbar hidden">
        <div class="bulk-action-info">
            <span id="bulk-selected-count">0</span> tasks selected
        </div>
        <div class="bulk-action-buttons">
            <button class="bulk-action-btn" id="bulk-complete-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Complete
            </button>
            <button class="bulk-action-btn" id="bulk-delete-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Delete
            </button>
            <button class="bulk-action-btn" id="bulk-label-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                Add Label
            </button>
            <button class="bulk-action-btn bulk-action-btn-cancel" id="bulk-cancel-btn">
                Cancel
            </button>
        </div>
    </div>

    <!-- Search & Sort Toolbar (CROWN⁴.5 Task 5) -->
    <div class="search-sort-toolbar">
        <div class="search-wrapper">
            <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" 
                   id="task-search-input" 
                   class="search-input" 
                   placeholder="Search tasks..."
                   autocomplete="off"
                   aria-label="Search tasks">
            <button id="search-clear-btn" class="search-clear-btn hidden" aria-label="Clear search">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <button id="semantic-search-toggle" class="semantic-search-toggle" title="AI Semantic Search - Find tasks by meaning, not just keywords">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                <span class="semantic-label">AI</span>
            </button>
        </div>
        <div class="sort-wrapper">
            <svg class="sort-icon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"/>
            </svg>
            <select id="task-sort-select" class="sort-select" aria-label="Sort tasks">
                <option value="default">Sort: Default</option>
                <option value="priority">Sort: Priority (High → Low)</option>
                <option value="priority-reverse">Sort: Priority (Low → High)</option>
                <option value="due-date">Sort: Due Date (Soonest first)</option>
                <option value="due-date-reverse">Sort: Due Date (Latest first)</option>
                <option value="created">Sort: Created (Newest first)</option>
                <option value="created-reverse">Sort: Created (Oldest first)</option>
                <option value="title">Sort: Title (A → Z)</option>
                <option value="title-reverse">Sort: Title (Z → A)</option>
            </select>
        </div>
        <button id="meeting-intelligence-toggle" class="meeting-intelligence-toggle" title="Group tasks by meeting">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            <span class="toggle-label">Group by Meeting</span>
        </button>
        <div class="toolbar-stats">
            <span id="visible-task-count">{{ tasks|length if tasks else 0 }}</span>
            <span class="stats-label">of</span>
            <span id="total-task-count">{{ tasks|length if tasks else 0 }}</span>
            <span class="stats-label">tasks</span>
        </div>
    </div>

    <!-- AI Proposals Section (CROWN⁴.5 Task 10) -->
    <div id="ai-proposals-container"></div>

    <!-- CROWN⁴.6 Meeting Heatmap -->
    <div id="meeting-filter-indicator"></div>
    <div id="meeting-heatmap-container"></div>

    <!-- Task List Container (CROWN⁴.5 Required Structure) -->
    <div id="tasks-list-container" class="tasks-list-container">
        {% if tasks and tasks|length > 0 %}
            {% for task in tasks %}
            {{ task_card(task) }}
            {% endfor %}
        {% endif %}
    </div>

    <!-- Empty State (CROWN⁴.5 Required ID) -->
    <div id="tasks-empty-state" class="empty-state{% if tasks and tasks|length > 0 %} hidden{% endif %}">
        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
        <h3 class="text-xl font-semibold mb-2">No tasks yet</h3>
        <p class="text-secondary mb-6">Tasks from your meetings will appear here</p>
        <button class="btn btn-primary" id="empty-state-create-btn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Create your first task
        </button>
    </div>

    <!-- Loading State (CROWN⁴.5 Skeleton Loaders) -->
    <div id="tasks-loading-state" class="tasks-loading-state hidden">
        <div class="task-skeleton">
            <div class="skeleton-checkbox"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-meta"></div>
            </div>
        </div>
        <div class="task-skeleton">
            <div class="skeleton-checkbox"></div>
            <div class="skeleton-content">
                <div class="skeleton-title skeleton-width-random"></div>
                <div class="skeleton-meta skeleton-width-random"></div>
            </div>
        </div>
        <div class="task-skeleton">
            <div class="skeleton-checkbox"></div>
            <div class="skeleton-content">
                <div class="skeleton-title skeleton-width-random"></div>
                <div class="skeleton-meta skeleton-width-random"></div>
            </div>
        </div>
        <div class="task-skeleton">
            <div class="skeleton-checkbox"></div>
            <div class="skeleton-content">
                <div class="skeleton-title skeleton-width-random"></div>
                <div class="skeleton-meta skeleton-width-random"></div>
            </div>
        </div>
        <div class="task-skeleton">
            <div class="skeleton-checkbox"></div>
            <div class="skeleton-content">
                <div class="skeleton-title skeleton-width-random"></div>
                <div class="skeleton-meta skeleton-width-random"></div>
            </div>
        </div>
    </div>

    <!-- Error State (CROWN⁴.5) -->
    <div id="tasks-error-state" class="tasks-error-state hidden">
        <svg class="error-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h3 class="error-state-title">Unable to load tasks</h3>
        <p class="error-state-message">We couldn't fetch your tasks. Please check your connection and try again.</p>
        <div class="error-state-actions">
            <button class="btn btn-primary" id="error-state-retry-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Retry
            </button>
            <button class="btn btn-secondary" id="error-state-clear-cache-btn">
                Clear Cache
            </button>
        </div>
    </div>
</div>

<!-- Task Creation Modal (CROWN Design System) -->
<div id="task-modal-overlay" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Create New Task</h2>
            <button class="modal-close" id="task-modal-close" type="button">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="task-create-form">
            <div class="modal-body">
                <!-- Title (Required) -->
                <div class="form-group">
                    <label class="form-label required" for="task-title">Task Title</label>
                    <input 
                        type="text" 
                        id="task-title" 
                        class="form-input" 
                        placeholder="What needs to be done?"
                        required
                        autocomplete="off"
                    >
                </div>
                
                <!-- Description (Optional) -->
                <div class="form-group">
                    <label class="form-label" for="task-description">Description</label>
                    <textarea 
                        id="task-description" 
                        class="form-input" 
                        placeholder="Add more details..."
                        rows="3"
                    ></textarea>
                </div>
                
                <!-- Priority -->
                <div class="form-group">
                    <label class="form-label" for="task-priority">Priority</label>
                    <select id="task-priority" class="form-input" style="display: none;">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                    <!-- Visual priority selector will be injected here by JavaScript -->
                </div>
                
                <!-- Due Date (Optional) -->
                <div class="form-group">
                    <label class="form-label" for="task-due-date">Due Date</label>
                    <input 
                        type="date" 
                        id="task-due-date" 
                        class="form-input"
                    >
                    <!-- Date shortcuts will be injected here by JavaScript -->
                </div>
                
                <!-- Assignee (Optional) -->
                <div class="form-group">
                    <label class="form-label" for="task-assignee">Assignee</label>
                    <input 
                        type="text" 
                        id="task-assignee" 
                        class="form-input" 
                        placeholder="Search users..."
                        autocomplete="off"
                    >
                    <!-- Assignee dropdown will be injected here by JavaScript -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="task-form-cancel">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" id="task-form-submit">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Create Task
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Snooze Duration Picker Modal -->
<div id="snooze-modal-overlay" class="task-modal-overlay hidden">
    <div class="task-modal task-modal-small">
        <div class="task-modal-header">
            <h2 class="task-modal-title">Snooze Task</h2>
            <button class="task-modal-close" id="snooze-modal-close">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <p class="text-secondary mb-4" id="snooze-task-title">Snooze this task until...</p>
            
            <div class="snooze-options">
                <button class="snooze-option-btn" data-duration="1h">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>1 Hour</span>
                </button>
                <button class="snooze-option-btn" data-duration="4h">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>4 Hours</span>
                </button>
                <button class="snooze-option-btn" data-duration="tomorrow">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>Tomorrow</span>
                </button>
                <button class="snooze-option-btn" data-duration="1w">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>1 Week</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Merge Task Selector Modal -->
<div id="merge-modal-overlay" class="task-modal-overlay hidden">
    <div class="task-modal task-modal-medium">
        <div class="task-modal-header">
            <h2 class="task-modal-title">Merge Tasks</h2>
            <button class="task-modal-close" id="merge-modal-close">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <p class="text-secondary mb-4" id="merge-task-title">Select a task to merge with:</p>
            
            <div id="merge-task-list" class="merge-task-list">
                <!-- Task options will be populated dynamically -->
            </div>
            
            <div class="mt-6 text-sm text-secondary">
                <p><strong>Note:</strong> The selected task will be merged into the current task. All labels, dates, and metadata will be combined.</p>
            </div>
        </div>
    </div>
</div>

<!-- Task Detail Modal (CROWN⁴.5 Task 7) -->
<div id="task-detail-modal-overlay" class="task-modal-overlay hidden">
    <div class="task-modal task-modal-large">
        <div class="task-modal-header">
            <h2 class="task-modal-title" id="task-detail-title">Task Details</h2>
            <button class="task-modal-close" id="task-detail-close">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Tab Navigation -->
        <div class="task-detail-tabs">
            <button class="task-detail-tab active" data-tab="details">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Details
            </button>
            <button class="task-detail-tab" data-tab="comments">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                Comments <span class="tab-badge" id="comments-count">0</span>
            </button>
            <button class="task-detail-tab" data-tab="history">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                History
            </button>
            <button class="task-detail-tab" data-tab="attachments">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                </svg>
                Attachments <span class="tab-badge" id="attachments-count">0</span>
            </button>
        </div>
        
        <div class="modal-body task-detail-body">
            <!-- Details Tab -->
            <div class="task-detail-panel active" data-panel="details">
                <div class="task-detail-section">
                    <label class="task-detail-label">Title</label>
                    <div class="task-detail-value editable" id="detail-title" contenteditable="false">
                        <!-- Title will be populated -->
                    </div>
                </div>
                
                <div class="task-detail-row">
                    <div class="task-detail-section">
                        <label class="task-detail-label">Status</label>
                        <select class="task-detail-select" id="detail-status">
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div class="task-detail-section">
                        <label class="task-detail-label">Priority</label>
                        <select class="task-detail-select" id="detail-priority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <div class="task-detail-row">
                    <div class="task-detail-section">
                        <label class="task-detail-label">Due Date</label>
                        <input type="date" class="task-detail-input" id="detail-due-date">
                    </div>
                    
                    <div class="task-detail-section">
                        <label class="task-detail-label">Created</label>
                        <div class="task-detail-value" id="detail-created">
                            <!-- Created date -->
                        </div>
                    </div>
                </div>
                
                <div class="task-detail-section">
                    <label class="task-detail-label">Assigned To</label>
                    <div class="task-assignees" id="detail-assignees">
                        <!-- Assignees will be populated -->
                    </div>
                </div>
                
                <div class="task-detail-section">
                    <label class="task-detail-label">Description</label>
                    <textarea class="task-detail-textarea" id="detail-description" placeholder="Add a description..." rows="4"></textarea>
                </div>
                
                <div class="task-detail-section">
                    <label class="task-detail-label">Source</label>
                    <div class="task-detail-value" id="detail-source">
                        <!-- Source info (AI/Manual) -->
                    </div>
                </div>
            </div>
            
            <!-- Comments Tab -->
            <div class="task-detail-panel" data-panel="comments">
                <div class="comments-list" id="comments-list">
                    <!-- Comments will be populated -->
                </div>
                
                <div class="comment-composer">
                    <textarea class="comment-input" id="comment-input" placeholder="Add a comment..." rows="3"></textarea>
                    <div class="comment-actions">
                        <button class="btn-secondary modal-btn" id="cancel-comment">Cancel</button>
                        <button class="btn-primary modal-btn" id="add-comment">Comment</button>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div class="task-detail-panel" data-panel="history">
                <div class="history-timeline" id="history-timeline">
                    <!-- History events will be populated -->
                </div>
            </div>
            
            <!-- Attachments Tab -->
            <div class="task-detail-panel" data-panel="attachments">
                <div class="attachments-empty" id="attachments-empty">
                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                    <p>No attachments yet</p>
                    <p class="text-secondary">Attachments feature coming soon</p>
                </div>
                <div class="attachments-list hidden" id="attachments-list">
                    <!-- Attachments will be populated -->
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn-secondary modal-btn" id="task-detail-cancel">Close</button>
            <button class="btn-primary modal-btn" id="task-detail-save">Save Changes</button>
        </div>
    </div>
</div>

<!-- Three Dots Task Actions Menu (Global Floating) - MUST BE BEFORE SCRIPTS -->
<div id="task-menu" role="menu" data-state="closed">
    <button class="task-menu-item" data-action="view-details" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>
        <span>View details</span>
    </button>
    <div class="task-menu-divider"></div>
    <button class="task-menu-item" data-action="edit" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
        <span>Edit task</span>
    </button>
    <button class="task-menu-item" data-action="toggle-status" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>Toggle complete</span>
    </button>
    <button class="task-menu-item" data-action="priority" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
        </svg>
        <span>Change priority</span>
    </button>
    <button class="task-menu-item" data-action="due-date" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <span>Set due date</span>
    </button>
    <button class="task-menu-item" data-action="assign" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        <span>Assign to...</span>
    </button>
    <button class="task-menu-item" data-action="labels" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
        </svg>
        <span>Edit labels</span>
    </button>
    <button class="task-menu-item" data-action="jump-to-transcript" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        <span>Jump to transcript</span>
    </button>
    <div class="task-menu-divider"></div>
    <button class="task-menu-item" data-action="duplicate" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
        <span>Duplicate</span>
    </button>
    <button class="task-menu-item" data-action="snooze" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>Snooze...</span>
    </button>
    <button class="task-menu-item" data-action="merge" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
        <span>Merge tasks...</span>
    </button>
    <div class="task-menu-divider"></div>
    <button class="task-menu-item" data-action="archive" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
        </svg>
        <span>Archive</span>
    </button>
    <button class="task-menu-item task-menu-item-destructive" data-action="delete" role="menuitem">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        <span>Delete</span>
    </button>
</div>

<!-- CROWN⁴.6: Populate task data for spoken provenance -->
<script nonce="{{ g.csp_nonce }}">
// Serialize tasks with all relationships for spoken provenance UI
window.tasks = {{ tasks_json|tojson|safe if tasks_json else '[]' }};
console.log('[CROWN⁴.6] Loaded', window.tasks.length, 'tasks for provenance UI');
</script>

<!-- CROWN⁴.6: Early First Paint marker - records timing before any scripts block -->
<script nonce="{{ g.csp_nonce }}">
window.__FIRST_PAINT_START = performance.now();
requestAnimationFrame(function(){requestAnimationFrame(function(){
    window.__FIRST_PAINT_TIME = performance.now() - window.__FIRST_PAINT_START;
    console.log('⚡ First Paint:', Math.round(window.__FIRST_PAINT_TIME) + 'ms');
})});
</script>

<!-- CSRF Protection - MUST load before other scripts to patch window.fetch -->
<script src="{{ url_for('static', filename='js/csrf.js') }}" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.6 TaskStateStore - MUST load first as single source of truth -->
<script defer src="{{ url_for('static', filename='js/task-state-store.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.5 Frontend Modules - ALL deferred for <200ms First Paint -->
<script defer src="{{ url_for('static', filename='js/quiet-state-manager.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/emotional-animations.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-animation-controller.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-cache.js') }}?v=4" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-search-sort.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-detail-modal.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-grouping.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/performance-validator.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/prefetch-controller.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-prefetch-adapter.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-bootstrap.js') }}?v=5" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-merge-ui.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-optimistic-ui.js') }}?v=5" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-inline-editing.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-confirmation-modal.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-date-picker.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-priority-selector.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-assignee-selector.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-labels-editor.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-duplicate-confirmation.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-snooze-modal.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-merge-modal.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-menu-controller.js') }}?v=3" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-actions-menu.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-bulk-operations.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-drag-drop.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-proposal-ui.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-offline-queue.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-multi-tab-sync.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-idle-sync.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/predictive-engine.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/cognitive-synchronizer.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-websocket-handlers.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-virtual-list.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-clustering.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/haptic-feedback.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-keyboard-shortcuts.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/reconciliation-cycle.js') }}" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.5 Phase 2: Cache-First Architecture -->
<script defer src="{{ url_for('static', filename='js/indexeddb-cache.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-store.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/temporal-recovery-engine.js') }}" nonce="{{ g.csp_nonce }}"></script>

<!-- Set user context variables (needs template rendering) -->
<script nonce="{{ g.csp_nonce }}">
// Set user context for WebSocket authentication and CROWN⁴.5 modules
window.CURRENT_USER_ID = {{ current_user.id if current_user.is_authenticated else 'null' }};
window.WORKSPACE_ID = {{ current_user.workspace_id if current_user.workspace_id else 'null' }};
window.CURRENT_SESSION_ID = null;
console.log('[DEBUG] User context set:', { userId: window.CURRENT_USER_ID, workspaceId: window.WORKSPACE_ID });
</script>

<!-- Global Modal Manager - Prevents modal stacking on mobile -->
<script defer src="{{ url_for('static', filename='js/modal-manager.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>

<!-- SmartSelectors - Reusable UI Components -->
<script defer src="{{ url_for('static', filename='js/task-smart-selectors.js') }}?v=5" nonce="{{ g.csp_nonce }}"></script>

<!-- TaskModalManager - Unified Create/Edit/View Modal -->
<script defer src="{{ url_for('static', filename='js/task-modal-manager.js') }}?v=6" nonce="{{ g.csp_nonce }}"></script>

<!-- Task page initialization -->
<script defer src="{{ url_for('static', filename='js/task-page-init.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-page-master-init.js') }}" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.6: Linear-Inspired Performance & Animations -->
<script defer src="{{ url_for('static', filename='js/tasks-linear-inspired.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/emotional-task-ui.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/spoken-provenance-ui.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.6: Meeting-Native Features -->
<script defer src="{{ url_for('static', filename='js/task-transcript-navigation.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-spoken-provenance.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/meeting-heatmap.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/task-context-preview.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/meeting-intelligence-mode.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/semantic-search.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/stress-indicators.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
<script defer src="{{ url_for('static', filename='js/dev-performance-panel.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.6 Task 5: Perfect Completion UX -->
<script defer src="{{ url_for('static', filename='js/task-completion-ux.js') }}?v=3" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.6: Mobile Gestures (swipe-to-complete/snooze, long-press context) -->
<script defer src="{{ url_for('static', filename='js/task-mobile-gestures.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.6: AI Partner Nudges (gentle PredictiveEngine suggestions) -->
<script defer src="{{ url_for('static', filename='js/ai-partner-nudges.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>

<!-- CROWN⁴.6: Task Page Orchestrator - MUST BE LAST to coordinate module initialization -->
<script defer src="{{ url_for('static', filename='js/task-page-orchestrator.js') }}?v=1" nonce="{{ g.csp_nonce }}"></script>
{% endblock %}
