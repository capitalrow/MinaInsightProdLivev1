{% extends "base.html" %}

{% block title %}Meetings - Mina{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/toast-notifications.css') }}">
<style>
.meetings-container {
  min-height: calc(100vh - var(--header-height));
  padding: var(--space-8) 0;
}
.meetings-header { margin-bottom: var(--space-8); animation: fadeInUp 0.6s ease-out; }
.meetings-title {
  font-size: var(--font-size-4xl);
  font-weight: var(--font-weight-bold);
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: var(--space-2);
}
.meetings-subtitle { color: var(--color-text-secondary); font-size: var(--font-size-lg); }
.meetings-tabs { display: flex; gap: var(--space-2); margin-bottom: var(--space-6); animation: fadeInUp 0.6s ease-out 0.05s both; }
.tab-btn {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: var(--space-3) var(--space-6);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all var(--transition-base);
}
.tab-btn.active {
  background: var(--gradient-primary);
  border-color: transparent;
  color: white;
  font-weight: var(--font-weight-semibold);
}
.filters-card {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  padding: var(--space-4);
  margin-bottom: var(--space-6);
}
.section-header {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-text-primary);
  margin: var(--space-8) 0 var(--space-4);
  padding-left: var(--space-2);
  border-left: 4px solid var(--color-primary);
}
.meeting-card {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  transition: all var(--transition-base);
  cursor: pointer;
  position: relative;
  overflow: hidden;
  margin-bottom: var(--space-4);
}
.meeting-card:hover { transform: translateX(8px); border-color: var(--color-primary); }
.meeting-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
  background: var(--gradient-primary); opacity: 0; transition: opacity var(--transition-base);
}
.meeting-card:hover::before { opacity: 1; }
.meeting-icon {
  width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;
  background: var(--gradient-primary); border-radius: var(--radius-xl); flex-shrink: 0;
}
.meeting-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-text-primary); margin-bottom: var(--space-1); }
.meeting-date { font-size: var(--font-size-sm); color: var(--color-text-tertiary); margin-bottom: var(--space-2); }
.meeting-meta { display: flex; gap: var(--space-3); margin-top: var(--space-3); flex-wrap: wrap; }
.meta-item { font-size: var(--font-size-xs); color: var(--color-text-tertiary); display: flex; align-items: center; gap: var(--space-1); }
.empty-state {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-2xl);
  padding: var(--space-16);
  text-align: center;
}
.loading-spinner { display: flex; justify-content: center; align-items: center; min-height: 200px; }
.undo-toast {
  position: fixed; bottom: 2rem; right: 2rem; background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  padding: var(--space-4);
  display: flex;
  align-items: center;
  gap: var(--space-4);
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideInRight 0.3s ease-out;
  z-index: 9999;
}
.undo-button {
  background: var(--color-primary);
  color: white;
  border: none;
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-lg);
  cursor: pointer;
  font-weight: var(--font-weight-medium);
}
@keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block content %}
<div class="container meetings-container">
  <div class="meetings-header">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="meetings-title">Meetings</h1>
        <p class="meetings-subtitle">View and manage all your recorded meetings</p>
      </div>
      <a href="{{ url_for('pages.live') }}" class="btn btn-primary">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        New Recording
      </a>
    </div>
  </div>

  <div class="meetings-tabs">
    <button class="tab-btn active" data-tab="active" onclick="switchTab('active')">
      Active <span class="tab-count" id="active-count">{{ active_count|default(0) }}</span>
    </button>
    <button class="tab-btn" data-tab="archive" onclick="switchTab('archive')">
      Archive <span class="tab-count" id="archive-count">{{ archive_count|default(0) }}</span>
    </button>
  </div>

  <div class="filters-card">
    <div style="display:grid;grid-template-columns:1fr auto;gap:var(--space-4);align-items:center;">
      <div class="flex gap-3 flex-wrap">
        <input type="search" class="input" id="search-input" placeholder="Search meetings..." style="max-width:400px;" oninput="filterMeetings()">
        <select class="input" id="time-filter" style="max-width:200px;" onchange="filterMeetings()">
          <option value="all">All Time</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="year">This Year</option>
        </select>
      </div>
    </div>
  </div>

  <div id="active-meetings" class="tab-content">
    <div id="loading-active" class="loading-spinner">
      <div style="font-size:var(--font-size-lg);color:var(--color-text-secondary);">Loading meetings...</div>
    </div>
    <div id="meetings-content" style="display:none;"></div>
  </div>

  <div id="archive-meetings" class="tab-content" style="display:none;">
    <div id="loading-archive" class="loading-spinner">
      <div style="font-size:var(--font-size-lg);color:var(--color-text-secondary);">Loading archived meetings...</div>
    </div>
    <div id="archive-content" style="display:none;"></div>
  </div>

  <div id="undo-toast-container"></div>
</div>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/toast-notifications.js') }}"></script>
<script nonce="{{ g.csp_nonce }}">
console.log("üé¨ Meetings Page v2.1 (Prefetch-integrated, stabilized)");

const WORKSPACE_ID = {{ workspace_id | tojson }};
let allMeetings=[], activeMeetings=[], archivedMeetings=[], currentTab='active', socket=null, undoTimers=new Map();

// CROWN‚Å¥.7: Counter stabilization with guarded pipeline
// Pattern: Initial load guard + queue for WebSocket events + debounced replay
const MeetingsStabilizer = {
  _loadComplete: false,
  _eventQueue: [], // Queue all WebSocket events during initial load
  _debounceTimer: null,
  _lastValues: { active: null, archive: null },
  _guardTimeout: null,
  
  init() {
    // Capture initial values from DOM (server-rendered)
    const activeEl = document.getElementById('active-count');
    const archiveEl = document.getElementById('archive-count');
    this._lastValues = {
      active: parseInt(activeEl?.textContent) || 0,
      archive: parseInt(archiveEl?.textContent) || 0
    };
    console.log('[MeetingsStabilizer] Initialized with server-rendered values:', this._lastValues);
    
    // Failsafe: release guard after 8 seconds if load never completes
    this._guardTimeout = setTimeout(() => {
      if (!this._loadComplete) {
        console.warn('[MeetingsStabilizer] Guard timeout - releasing');
        this.releaseGuard();
      }
    }, 8000);
  },
  
  _applyCountersDebounced(activeCount, archiveCount) {
    if (this._debounceTimer) {
      clearTimeout(this._debounceTimer);
    }
    
    this._debounceTimer = setTimeout(() => {
      const activeEl = document.getElementById('active-count');
      const archiveEl = document.getElementById('archive-count');
      
      if (activeEl && this._lastValues.active !== activeCount) {
        activeEl.textContent = activeCount;
        activeEl.classList.add('counter-updated');
        setTimeout(() => activeEl.classList.remove('counter-updated'), 300);
        this._lastValues.active = activeCount;
      }
      if (archiveEl && this._lastValues.archive !== archiveCount) {
        archiveEl.textContent = archiveCount;
        archiveEl.classList.add('counter-updated');
        setTimeout(() => archiveEl.classList.remove('counter-updated'), 300);
        this._lastValues.archive = archiveCount;
      }
    }, 100);
  },
  
  _applyCountersImmediate(activeCount, archiveCount) {
    const activeEl = document.getElementById('active-count');
    const archiveEl = document.getElementById('archive-count');
    
    if (activeEl) {
      activeEl.textContent = activeCount;
      this._lastValues.active = activeCount;
    }
    if (archiveEl) {
      archiveEl.textContent = archiveCount;
      this._lastValues.archive = archiveCount;
    }
  },
  
  updateCounters(activeCount, archiveCount, isInitialLoad = false) {
    // Initial API load: apply immediately and release guard
    if (isInitialLoad) {
      this._applyCountersImmediate(activeCount, archiveCount);
      console.log('[MeetingsStabilizer] Initial counter update:', activeCount, archiveCount);
      this.releaseGuard();
      return;
    }
    
    // During guard: queue WebSocket events for replay
    if (!this._loadComplete) {
      console.log('[MeetingsStabilizer] Queuing event during guard:', activeCount, archiveCount);
      this._eventQueue.push({ active: activeCount, archive: archiveCount });
      return;
    }
    
    // After guard released: debounce all updates
    this._applyCountersDebounced(activeCount, archiveCount);
  },
  
  releaseGuard() {
    if (this._loadComplete) return;
    
    this._loadComplete = true;
    if (this._guardTimeout) {
      clearTimeout(this._guardTimeout);
      this._guardTimeout = null;
    }
    
    console.log(`[MeetingsStabilizer] Guard released, replaying ${this._eventQueue.length} queued events`);
    
    // Replay all queued events through debounce
    if (this._eventQueue.length > 0) {
      // Apply final state from queue through debounce
      const finalEvent = this._eventQueue[this._eventQueue.length - 1];
      this._applyCountersDebounced(finalEvent.active, finalEvent.archive);
    }
    this._eventQueue = [];
  }
};

// Initialize stabilizer
MeetingsStabilizer.init();

// üîó Hook into Dashboard globals (GSAP + Prefetch)
window.handleMeetingHover = window.handleCardHover || function(){};
window.handleMeetingClick = window.handleCardClick || function(e){
  const card=e.currentTarget; const sid=card.dataset.sessionId;
  console.warn("‚ö†Ô∏è Prefetch pipeline unavailable, fallback nav:",sid);
  window.location.href=`/sessions/${sid}/refined`;
};
window.initMeetingTransitions = window.initMorphTransitions || function(){};

document.addEventListener("DOMContentLoaded",()=>{loadMeetings();connectWebSocket();});

// ---------------------- Load Meetings ----------------------
async function loadMeetings(){
  const la=document.getElementById('loading-active'), lb=document.getElementById('loading-archive');
  try{
    const res=await fetch('/api/sessions',{credentials:'same-origin'});
    if(!res.ok)throw new Error(res.statusText);
    const data=await res.json();
    allMeetings=data.upserts||[];
    separateMeetings(true); renderMeetings(); // true = initial load, counters update immediately
  }catch(e){
    console.error('‚ùå Load failed',e); showError('Failed to load meetings');
  }finally{
    la.style.display='none'; lb.style.display='none';
  }
}

function separateMeetings(isFromInitialLoad = false){
  activeMeetings=allMeetings.filter(m=>m.status!=='archived');
  archivedMeetings=allMeetings.filter(m=>m.status==='archived');
  // Use stabilizer for debounced counter updates
  MeetingsStabilizer.updateCounters(activeMeetings.length, archivedMeetings.length, isFromInitialLoad);
}

function groupMeetings(list){
  const today=new Date(), weekAgo=new Date(today.getTime()-7*86400000);
  const groups={today:[],thisWeek:[],earlier:[]};
  list.forEach(m=>{
    const d=new Date(m.started_at);
    if(d>=today)groups.today.push(m);
    else if(d>=weekAgo)groups.thisWeek.push(m);
    else groups.earlier.push(m);
  }); return groups;
}

function renderMeetings(){
  const list=currentTab==='active'?activeMeetings:archivedMeetings;
  const container=document.getElementById(currentTab==='active'?'meetings-content':'archive-content');
  const loading=document.getElementById(currentTab==='active'?'loading-active':'loading-archive');
  loading.style.display='none'; container.style.display='block';
  if(list.length===0){container.innerHTML=`<div class="empty-state"><div style="font-size:4rem;opacity:.3;">üìã</div><h2>No ${currentTab} meetings</h2></div>`;return;}
  const g=groupMeetings(list); let html='';
  for(const [k,v] of Object.entries(g)){ if(v.length===0)continue;
    html+=`<h2 class="section-header">${k==='today'?'Today':k==='thisWeek'?'This Week':'Earlier'}</h2>`+v.map(renderMeetingCard).join('');
  }
  container.innerHTML=html; if(!container.dataset.navInit) initMeetingsDelegation(container);
}

function initMeetingsDelegation(c){
  c.dataset.navInit='1';
  c.addEventListener('mouseenter',e=>{
    const card=e.target.closest('[data-meeting-card]');
    if(card)window.handleMeetingHover({currentTarget:card});
  },true);
  c.addEventListener('click',e=>{
    const card=e.target.closest('[data-meeting-card]');
    if(!card)return;
    e.preventDefault(); e.stopPropagation();
    window.handleMeetingClick({currentTarget:card,preventDefault:()=>{},stopPropagation:()=>{}});
  });
}

function renderMeetingCard(m){
  const d=new Date(m.started_at), sid=m.session_id, title=m.title||'Untitled Meeting';
  return `
  <div class="meeting-card" data-meeting-card data-session-id="${sid}" data-meeting-id="${m.id}" data-meeting-title="${title}" role="link" tabindex="0" aria-label="Open meeting ${title}">
    <div class="flex justify-between items-start gap-4">
      <div class="flex gap-4 flex-1">
        <div class="meeting-icon">üéôÔ∏è</div>
        <div class="flex-1">
          <h3 class="meeting-title">${title}</h3>
          <p class="meeting-date">${formatDate(d)}</p>
          ${m.summary?`<p class="meeting-summary">${m.summary.substring(0,150)}...</p>`:''}
          <div class="meeting-meta">
            ${m.duration_s?`<span class="meta-item">‚è±Ô∏è ${Math.round(m.duration_s/60)} min</span>`:''}
            ${m.tasks?`<span class="meta-item">‚úÖ ${m.tasks} tasks</span>`:''}
            ${m.highlights?`<span class="meta-item">‚≠ê ${m.highlights} highlights</span>`:''}
          </div>
        </div>
      </div>
      <div class="meeting-actions" data-stop-propagation>
        ${currentTab==='active'
          ?`<button class="btn btn-sm" data-stop-propagation onclick="archiveMeeting('${sid}')">Archive</button>`
          :`<button class="btn btn-sm" data-stop-propagation onclick="restoreMeeting('${sid}',true)">Restore</button>`}
      </div>
    </div>
  </div>`;
}

function formatDate(d){return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});}
function switchTab(t){currentTab=t;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));document.getElementById('active-meetings').style.display=t==='active'?'block':'none';document.getElementById('archive-meetings').style.display=t==='archive'?'block':'none';renderMeetings();}

async function archiveMeeting(id){try{const res=await fetch(`/api/sessions/${id}`,{method:'PATCH',credentials:'same-origin',headers:{'Content-Type':'application/json'},body:JSON.stringify({operation:'archive'})});if(!res.ok)throw new Error();const m=allMeetings.find(x=>x.session_id===id);if(m){m.status='archived';separateMeetings();renderMeetings();showUndoToast(id,m.title);}}catch(e){console.error(e);window.toast?.error('Failed to archive meeting');}}

async function restoreMeeting(id,isUndo=false){try{const res=await fetch(`/api/sessions/${id}`,{method:'PATCH',credentials:'same-origin',headers:{'Content-Type':'application/json'},body:JSON.stringify({operation:'restore'})});if(!res.ok)throw new Error();const m=allMeetings.find(x=>x.session_id===id);if(m){m.status='ready';separateMeetings();renderMeetings();if(!isUndo)window.toast?.success('Meeting restored');}if(undoTimers.has(id)){clearTimeout(undoTimers.get(id));undoTimers.delete(id);hideUndoToast(id);}}catch(e){console.error(e);window.toast?.error('Failed to restore meeting');}}

function showUndoToast(id,title){const c=document.getElementById('undo-toast-container');const toast=document.createElement('div');toast.id=`undo-${id}`;toast.className='undo-toast';toast.innerHTML=`<span>Meeting archived</span><button class="undo-button" onclick="restoreMeeting('${id}',true)">Undo</button>`;c.appendChild(toast);const timer=setTimeout(()=>{hideUndoToast(id);undoTimers.delete(id);},5000);undoTimers.set(id,timer);}
function hideUndoToast(id){const t=document.getElementById(`undo-${id}`);if(t){t.style.animation='slideOutRight 0.3s ease-out';setTimeout(()=>t.remove(),300);}}

function connectWebSocket(){
  socket=io('/meetings');
  socket.on('connect',()=>{socket.emit('join_workspace',{workspace_id:WORKSPACE_ID});});
  socket.on('meeting_created',d=>{loadMeetings();});
  socket.on('meeting_updated',d=>{
    const m=allMeetings.find(x=>x.meeting_id===d.meeting_id);
    if(m){Object.assign(m,d.meeting_data);separateMeetings();renderMeetings();}
  });
}

function showError(msg){const c=document.getElementById('meetings-content');c.innerHTML=`<div class="empty-state"><h2>Error</h2><p>${msg}</p></div>`;}
</script>
{% endblock %}
