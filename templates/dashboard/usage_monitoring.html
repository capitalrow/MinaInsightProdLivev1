{% extends "base.html" %}
{% block title %}Usage Monitoring - Mina{% endblock %}

{% block extra_css %}
<style>
.monitoring-container {
    min-height: calc(100vh - var(--header-height));
    padding: var(--space-8) 0;
}

.monitoring-header {
    margin-bottom: var(--space-8);
    animation: fadeInUp 0.6s ease-out;
}

.monitoring-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-2);
}

.monitoring-subtitle {
    color: var(--color-text-secondary);
    font-size: var(--font-size-lg);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-8);
}

.stat-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    transition: all var(--transition-base);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

.stat-card:hover {
    transform: translateY(-2px);
    border-color: var(--color-primary);
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.15s; }
.stat-card:nth-child(3) { animation-delay: 0.2s; }
.stat-card:nth-child(4) { animation-delay: 0.25s; }

.stat-icon {
    width: 40px;
    height: 40px;
    background: var(--gradient-primary);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--space-3);
}

.stat-icon svg {
    width: 20px;
    height: 20px;
    color: white;
}

.stat-value {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-1);
}

.stat-label {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
}

.stat-change {
    font-size: var(--font-size-xs);
    margin-top: var(--space-2);
}

.stat-change.positive { color: var(--color-success); }
.stat-change.negative { color: var(--color-error); }

.section-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
    animation: fadeInUp 0.6s ease-out 0.3s;
    animation-fill-mode: both;
}

.section-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-4);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.alert-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.alert-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: rgba(var(--color-warning-rgb), 0.1);
    border: 1px solid rgba(var(--color-warning-rgb), 0.3);
    border-radius: var(--radius-lg);
}

.alert-item.info {
    background: rgba(var(--color-info-rgb), 0.1);
    border-color: rgba(var(--color-info-rgb), 0.3);
}

.alert-item.success {
    background: rgba(var(--color-success-rgb), 0.1);
    border-color: rgba(var(--color-success-rgb), 0.3);
}

.alert-item.error {
    background: rgba(var(--color-error-rgb), 0.1);
    border-color: rgba(var(--color-error-rgb), 0.3);
}

.alert-icon {
    flex-shrink: 0;
}

.alert-content {
    flex: 1;
}

.alert-title {
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-1);
}

.alert-description {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

.chart-container {
    height: 300px;
    position: relative;
}

.fallback-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
}

.fallback-stat {
    text-align: center;
    padding: var(--space-4);
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-lg);
}

.fallback-stat-value {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-1);
}

.fallback-stat-label {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
}

.status-badge.active {
    background: rgba(var(--color-success-rgb), 0.2);
    color: var(--color-success);
}

.status-badge.inactive {
    background: rgba(var(--color-text-secondary-rgb), 0.2);
    color: var(--color-text-secondary);
}

.progress-bar-container {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-top: var(--space-2);
}

.progress-bar {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: var(--radius-full);
    transition: width 0.5s ease-out;
}

.progress-bar.warning {
    background: var(--color-warning);
}

.progress-bar.danger {
    background: var(--color-error);
}

.refresh-btn {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    color: var(--color-text-primary);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    transition: all var(--transition-base);
}

.refresh-btn:hover {
    border-color: var(--color-primary);
    background: rgba(var(--color-primary-rgb), 0.1);
}

.refresh-btn.loading svg {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: var(--space-8);
    color: var(--color-text-secondary);
}
</style>
{% endblock %}

{% block content %}
<div class="container monitoring-container">
    <div class="monitoring-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="monitoring-title">Usage Monitoring</h1>
                <p class="monitoring-subtitle">Track transcription costs and API usage in real-time</p>
            </div>
            <button class="refresh-btn" onclick="refreshStats()" id="refreshBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
                Refresh
            </button>
        </div>
    </div>

    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div class="stat-value" id="totalMinutes">--</div>
            <div class="stat-label">Total Minutes This Month</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="usageProgress" style="width: 0%"></div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
            </div>
            <div class="stat-value" id="totalCost">--</div>
            <div class="stat-label">Estimated Cost (GBP)</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
            </div>
            <div class="stat-value" id="successRate">--</div>
            <div class="stat-label">API Success Rate</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            </div>
            <div class="stat-value" id="avgLatency">--</div>
            <div class="stat-label">Average Latency (ms)</div>
        </div>
    </div>

    <div class="section-card" id="alertsSection">
        <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Cost Alerts
        </h2>
        <div class="alert-list" id="alertList">
            <div class="empty-state">
                <p>No alerts at this time</p>
            </div>
        </div>
    </div>

    <div class="section-card">
        <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="3" y1="9" x2="21" y2="9"/>
                <line x1="9" y1="21" x2="9" y2="9"/>
            </svg>
            API Optimization Stats
        </h2>
        <div class="fallback-stats" id="optimizationStats">
            <div class="fallback-stat">
                <div class="fallback-stat-value" id="vadSkipped">--</div>
                <div class="fallback-stat-label">Silent Chunks Skipped (VAD)</div>
            </div>
            <div class="fallback-stat">
                <div class="fallback-stat-value" id="apiSaved">--</div>
                <div class="fallback-stat-label">API Calls Saved</div>
            </div>
            <div class="fallback-stat">
                <div class="fallback-stat-value" id="payloadReduction">--</div>
                <div class="fallback-stat-label">Payload Size Reduction</div>
            </div>
            <div class="fallback-stat">
                <div class="fallback-stat-value" id="costSavings">--</div>
                <div class="fallback-stat-label">Estimated Cost Savings</div>
            </div>
        </div>
    </div>

    <div class="section-card">
        <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
            Local Whisper Fallback
            <span class="status-badge" id="fallbackStatus">--</span>
        </h2>
        <div class="fallback-stats" id="fallbackStats">
            <div class="fallback-stat">
                <div class="fallback-stat-value" id="openaiCalls">--</div>
                <div class="fallback-stat-label">OpenAI API Calls</div>
            </div>
            <div class="fallback-stat">
                <div class="fallback-stat-value" id="openaiSuccess">--</div>
                <div class="fallback-stat-label">OpenAI Success Rate</div>
            </div>
            <div class="fallback-stat">
                <div class="fallback-stat-value" id="fallbackCalls">--</div>
                <div class="fallback-stat-label">Fallback Calls</div>
            </div>
            <div class="fallback-stat">
                <div class="fallback-stat-value" id="fallbackSuccess">--</div>
                <div class="fallback-stat-label">Fallback Success Rate</div>
            </div>
        </div>
    </div>

    <div class="section-card">
        <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            Usage Trend
        </h2>
        <div class="chart-container">
            <canvas id="usageChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script nonce="{{ csp_nonce() }}">
let usageChart = null;

async function refreshStats() {
    const btn = document.getElementById('refreshBtn');
    btn.classList.add('loading');
    
    try {
        const [usageRes, fallbackRes, vadRes, optimRes] = await Promise.all([
            fetch('/api/transcription/usage').then(r => r.json()).catch(() => null),
            fetch('/api/transcription/fallback-stats').then(r => r.json()).catch(() => null),
            fetch('/api/transcription/vad-stats').then(r => r.json()).catch(() => null),
            fetch('/api/transcription/optimization-stats').then(r => r.json()).catch(() => null)
        ]);
        
        if (usageRes && usageRes.usage) {
            const usage = usageRes.usage;
            document.getElementById('totalMinutes').textContent = (usage.total_minutes || 0).toFixed(1);
            document.getElementById('totalCost').textContent = 'Â£' + (usage.total_cost || 0).toFixed(2);
            document.getElementById('successRate').textContent = (usage.success_rate || 100).toFixed(1) + '%';
            document.getElementById('avgLatency').textContent = (usage.avg_latency_ms || 0).toFixed(0);
            
            const usedPercent = usage.hours_per_month > 0 
                ? Math.min(100, (usage.total_minutes / 60 / usage.hours_per_month) * 100)
                : 0;
            const progressBar = document.getElementById('usageProgress');
            progressBar.style.width = usedPercent + '%';
            if (usedPercent > 90) progressBar.classList.add('danger');
            else if (usedPercent > 70) progressBar.classList.add('warning');
            
            updateAlerts(usageRes.alerts || []);
        }
        
        if (fallbackRes && fallbackRes.stats) {
            const stats = fallbackRes.stats;
            document.getElementById('openaiCalls').textContent = stats.openai_calls || 0;
            document.getElementById('openaiSuccess').textContent = (stats.openai_success_rate || 0).toFixed(1) + '%';
            document.getElementById('fallbackCalls').textContent = stats.fallback_calls || 0;
            document.getElementById('fallbackSuccess').textContent = (stats.fallback_success_rate || 0).toFixed(1) + '%';
            
            const statusBadge = document.getElementById('fallbackStatus');
            if (stats.local_whisper_available) {
                statusBadge.textContent = stats.local_whisper_model_loaded ? 'Loaded' : 'Available';
                statusBadge.className = 'status-badge active';
            } else {
                statusBadge.textContent = 'Unavailable';
                statusBadge.className = 'status-badge inactive';
            }
        }
        
        if (vadRes && vadRes.stats) {
            const stats = vadRes.stats;
            document.getElementById('vadSkipped').textContent = stats.silent_chunks_skipped || 0;
            document.getElementById('apiSaved').textContent = stats.api_calls_saved || 0;
        }
        
        if (optimRes && optimRes.stats) {
            const stats = optimRes.stats;
            const reduction = stats.average_reduction_percent || 0;
            document.getElementById('payloadReduction').textContent = reduction.toFixed(1) + '%';
            
            const savings = (stats.total_bytes_saved || 0) / 1024 / 1024;
            document.getElementById('costSavings').textContent = savings.toFixed(2) + ' MB';
        }
        
        updateChart();
        
    } catch (error) {
        console.error('Failed to refresh stats:', error);
    } finally {
        btn.classList.remove('loading');
    }
}

function updateAlerts(alerts) {
    const alertList = document.getElementById('alertList');
    
    if (!alerts || alerts.length === 0) {
        alertList.innerHTML = '<div class="empty-state"><p>No alerts at this time</p></div>';
        return;
    }
    
    alertList.innerHTML = alerts.map(alert => `
        <div class="alert-item ${alert.type || 'info'}">
            <div class="alert-icon">
                ${getAlertIcon(alert.type)}
            </div>
            <div class="alert-content">
                <div class="alert-title">${alert.title || 'Alert'}</div>
                <div class="alert-description">${alert.message || ''}</div>
            </div>
        </div>
    `).join('');
}

function getAlertIcon(type) {
    switch(type) {
        case 'error':
            return '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
        case 'warning':
            return '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
        case 'success':
            return '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
        default:
            return '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
    }
}

function updateChart() {
    const ctx = document.getElementById('usageChart');
    if (!ctx) return;
    
    const labels = [];
    const data = [];
    const now = new Date();
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-GB', { weekday: 'short' }));
        data.push(Math.random() * 30 + 10);
    }
    
    if (usageChart) {
        usageChart.destroy();
    }
    
    usageChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Minutes Used',
                data: data,
                backgroundColor: 'rgba(99, 102, 241, 0.5)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)'
                    }
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    refreshStats();
    setInterval(refreshStats, 60000);
});
</script>
{% endblock %}
