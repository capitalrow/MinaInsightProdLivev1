{% extends "base.html" %}

{% block title %}Analytics - Mina{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/crown5-analytics.css') }}">
<style>
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.analytics-tab:focus-visible,
.kpi-card:focus-visible,
.chart-card:focus-visible,
.btn:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
}

.analytics-workspace {
    width: clamp(320px, 95vw, 1400px);
    max-width: 100%;
    min-height: calc(100vh - 64px);
    margin: 0 auto;
    padding: var(--space-6) var(--space-4);
}

@media (min-width: 768px) {
    .analytics-workspace {
        padding: var(--space-8) var(--space-6);
    }
}

.analytics-header {
    margin-bottom: var(--space-6);
    animation: crownFadeIn 0.5s ease-out;
}

.analytics-title {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 700;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-2);
    letter-spacing: -0.02em;
}

.analytics-subtitle {
    color: var(--color-text-secondary);
    font-size: var(--font-size-base);
}

/* ============================================================================
   TIER 1: EXECUTIVE SUMMARY - Premium Hero Section
   ============================================================================ */
.tier1-executive-summary {
    background: linear-gradient(135deg, 
        rgba(99, 102, 241, 0.08) 0%, 
        rgba(139, 92, 246, 0.06) 50%, 
        rgba(6, 182, 212, 0.04) 100%);
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
    position: relative;
    overflow: hidden;
    animation: crownFadeIn 0.6s ease-out 0.1s both;
}

.tier1-executive-summary::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
    pointer-events: none;
}

.health-score-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

@media (min-width: 768px) {
    .health-score-container {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
    }
}

.health-score-main {
    display: flex;
    align-items: center;
    gap: var(--space-5);
}

.health-score-ring {
    position: relative;
    width: 110px;
    height: 110px;
    flex-shrink: 0;
}

.health-score-ring svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.health-score-ring-bg {
    fill: none;
    stroke: rgba(107, 114, 128, 0.15);
    stroke-width: 4;
}

.health-score-ring-arc {
    fill: none;
    stroke: url(#healthGradient);
    stroke-width: 4;
    stroke-dasharray: 0, 100;
    stroke-linecap: round;
    transition: stroke-dasharray 1.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.health-score-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.health-score-value {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
}

.health-score-label {
    font-size: 0.7rem;
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 2px;
}

.health-score-info h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--space-1);
}

.health-score-message {
    color: var(--color-text-secondary);
    font-size: 0.9rem;
    margin-bottom: var(--space-2);
}

.health-score-trend {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 500;
}

.health-score-trend.up {
    background: rgba(34, 197, 94, 0.1);
    color: var(--color-success);
}

.health-score-trend.down {
    background: rgba(239, 68, 68, 0.1);
    color: var(--color-error);
}

.health-score-trend.stable {
    background: rgba(107, 114, 128, 0.1);
    color: var(--color-text-secondary);
}

.health-breakdown {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3);
}

@media (min-width: 768px) {
    .health-breakdown {
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);
    }
}

.health-breakdown-item {
    text-align: center;
    padding: var(--space-3);
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-lg);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.2s ease;
}

.health-breakdown-item:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(99, 102, 241, 0.2);
}

.health-breakdown-label {
    font-size: 0.7rem;
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-1);
}

.health-breakdown-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

/* ============================================================================
   TIER 2: KPI CARDS - Streamlined Grid
   ============================================================================ */
.tier2-kpi-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

@media (min-width: 768px) {
    .tier2-kpi-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.kpi-card {
    background: rgba(30, 41, 59, 0.6);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: crownFadeIn 0.5s ease-out both;
}

.kpi-card:nth-child(1) { animation-delay: 0.15s; }
.kpi-card:nth-child(2) { animation-delay: 0.2s; }
.kpi-card:nth-child(3) { animation-delay: 0.25s; }
.kpi-card:nth-child(4) { animation-delay: 0.3s; }

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--kpi-accent, linear-gradient(90deg, #6366f1, #8b5cf6));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-4px);
    border-color: rgba(99, 102, 241, 0.3);
    box-shadow: 
        0 20px 40px -12px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(99, 102, 241, 0.1);
}

.kpi-card:hover::before {
    opacity: 1;
}

.kpi-card[data-kpi="meetings"] { --kpi-accent: linear-gradient(90deg, #6366f1, #818cf8); }
.kpi-card[data-kpi="tasks"] { --kpi-accent: linear-gradient(90deg, #8b5cf6, #a78bfa); }
.kpi-card[data-kpi="hours"] { --kpi-accent: linear-gradient(90deg, #06b6d4, #22d3ee); }
.kpi-card[data-kpi="duration"] { --kpi-accent: linear-gradient(90deg, #ec4899, #f472b6); }

.kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-3);
}

.kpi-label {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    font-weight: 500;
}

.kpi-badge {
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.kpi-badge.up {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
}

.kpi-badge.down {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
}

.kpi-badge.neutral {
    background: rgba(107, 114, 128, 0.15);
    color: var(--color-text-secondary);
}

.kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text-primary);
    line-height: 1.1;
    margin-bottom: var(--space-1);
}

.kpi-comparison {
    font-size: 0.8rem;
    color: var(--color-text-tertiary);
}

/* ============================================================================
   TIER 2: ACTIONABLE INSIGHTS - Consolidated Cards
   ============================================================================ */
.tier2-actionable-insights {
    margin-bottom: var(--space-6);
    animation: crownFadeIn 0.5s ease-out 0.35s both;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.section-badge {
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
    padding: var(--space-1) var(--space-2);
    background: rgba(107, 114, 128, 0.1);
    border-radius: var(--radius-full);
}

.insights-grid {
    display: grid;
    gap: var(--space-4);
}

@media (min-width: 768px) {
    .insights-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) {
    .insights-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

.insight-card {
    background: rgba(30, 41, 59, 0.5);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(148, 163, 184, 0.08);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    transition: all 0.3s ease;
}

.insight-card:hover {
    background: rgba(30, 41, 59, 0.7);
    border-color: rgba(99, 102, 241, 0.2);
    transform: translateY(-2px);
}

.insight-card.success { border-left: 3px solid #22c55e; }
.insight-card.warning { border-left: 3px solid #f59e0b; }
.insight-card.info { border-left: 3px solid #6366f1; }
.insight-card.action { border-left: 3px solid #8b5cf6; }

.insight-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--space-3);
}

.insight-card.success .insight-icon { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
.insight-card.warning .insight-icon { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
.insight-card.info .insight-icon { background: rgba(99, 102, 241, 0.15); color: #6366f1; }
.insight-card.action .insight-icon { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }

.insight-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--space-1);
}

.insight-description {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
}

.insight-action {
    margin-top: var(--space-3);
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.8rem;
    color: var(--color-primary);
    font-weight: 500;
    cursor: pointer;
    transition: gap 0.2s ease;
}

.insight-action:hover {
    gap: var(--space-2);
}

/* ============================================================================
   TIER 3: DEEP DIVE ACCORDION - Consolidated Analytics
   ============================================================================ */
.tier3-deep-dive {
    animation: crownFadeIn 0.5s ease-out 0.4s both;
}

.deep-dive-section {
    background: rgba(30, 41, 59, 0.4);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(148, 163, 184, 0.08);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-4);
    overflow: hidden;
}

.deep-dive-header {
    padding: var(--space-4) var(--space-5);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s ease;
}

.deep-dive-header:hover {
    background: rgba(99, 102, 241, 0.05);
}

.deep-dive-header h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.deep-dive-header .icon {
    width: 20px;
    height: 20px;
    color: var(--color-primary);
}

.deep-dive-toggle {
    width: 24px;
    height: 24px;
    color: var(--color-text-tertiary);
    transition: transform 0.3s ease;
}

.deep-dive-section.open .deep-dive-toggle {
    transform: rotate(180deg);
}

.deep-dive-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.deep-dive-section.open .deep-dive-content {
    max-height: 2000px;
}

.deep-dive-body {
    padding: 0 var(--space-5) var(--space-5);
}

/* Consolidated Chart Cards */
.consolidated-chart-grid {
    display: grid;
    gap: var(--space-4);
}

@media (min-width: 768px) {
    .consolidated-chart-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.chart-card {
    background: rgba(30, 41, 59, 0.5);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(148, 163, 184, 0.08);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
}

.chart-card h4 {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--space-1);
}

.chart-card .chart-subtitle {
    font-size: 0.8rem;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-4);
}

.chart-frame {
    position: relative;
    width: 100%;
    min-height: 200px;
}

.chart-frame canvas {
    width: 100% !important;
    height: 100% !important;
}

/* ============================================================================
   ONBOARDING BANNER - Progressive Disclosure
   ============================================================================ */
.onboarding-banner {
    background: linear-gradient(135deg, 
        rgba(99, 102, 241, 0.1) 0%, 
        rgba(139, 92, 246, 0.08) 100%);
    border: 1px dashed rgba(99, 102, 241, 0.3);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    text-align: center;
    margin-bottom: var(--space-6);
}

.onboarding-banner.hidden {
    display: none;
}

.onboarding-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto var(--space-4);
    background: rgba(99, 102, 241, 0.1);
    border-radius: var(--radius-xl);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary);
}

.onboarding-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.onboarding-description {
    color: var(--color-text-secondary);
    font-size: 0.95rem;
    max-width: 400px;
    margin: 0 auto var(--space-4);
    line-height: 1.6;
}

.onboarding-cta {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border-radius: var(--radius-lg);
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
    transition: all 0.2s ease;
}

.onboarding-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
}

/* ============================================================================
   ANIMATIONS
   ============================================================================ */
@keyframes crownFadeIn {
    from {
        opacity: 0;
        transform: translateY(12px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes crownPulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(99, 102, 241, 0);
    }
}

.crown5-updating {
    animation: crownPulse 0.6s ease-out;
}

/* ============================================================================
   RESPONSIVE REFINEMENTS
   ============================================================================ */
@media (max-width: 640px) {
    .analytics-workspace {
        padding: var(--space-4) var(--space-3);
    }
    
    .tier1-executive-summary {
        padding: var(--space-4);
    }
    
    .health-score-ring {
        width: 90px;
        height: 90px;
    }
    
    .health-score-value {
        font-size: 1.5rem;
    }
    
    .kpi-value {
        font-size: 1.5rem;
    }
    
    .kpi-card {
        padding: var(--space-4);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-workspace" role="main" aria-label="Analytics Dashboard">
    <div id="analytics-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Header -->
    <header class="analytics-header">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="analytics-title">Analytics</h1>
                <p class="analytics-subtitle">Insights from your meetings and productivity</p>
            </div>
            <div class="flex gap-2 flex-wrap">
                <select id="date-range-select" class="px-3 py-2 text-sm rounded-lg bg-white/5 border border-white/10 text-white focus:border-primary focus:outline-none" aria-label="Select date range">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
                <button class="btn btn-outline text-sm" id="exportAnalyticsBtn" aria-label="Export analytics">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>
    </header>

    <!-- Onboarding Banner (shown when < 3 meetings) -->
    <div id="onboarding-banner" class="onboarding-banner {% if total_meetings >= 3 %}hidden{% endif %}">
        <div class="onboarding-icon">
            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
        </div>
        <h2 class="onboarding-title">Unlock Your Meeting Analytics</h2>
        <p class="onboarding-description">Record at least 3 meetings to unlock detailed analytics, trends, and personalized recommendations.</p>
        <a href="{{ url_for('dashboard.index') }}" class="onboarding-cta">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
            </svg>
            Start Recording
        </a>
    </div>

    <!-- TIER 1: Executive Summary -->
    <section id="tier1-summary" class="tier1-executive-summary" role="region" aria-label="Executive Summary">
        <svg width="0" height="0" style="position: absolute;">
            <defs>
                <linearGradient id="healthGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#6366f1"/>
                    <stop offset="100%" style="stop-color:#8b5cf6"/>
                </linearGradient>
            </defs>
        </svg>
        
        <div class="health-score-container">
            <div class="health-score-main">
                <div class="health-score-ring" role="img" aria-label="Meeting Health Score">
                    <svg viewBox="0 0 36 36">
                        <path class="health-score-ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path id="health-score-arc" class="health-score-ring-arc" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <div class="health-score-center">
                        <span id="health-score-value" class="health-score-value" aria-live="polite">—</span>
                        <span class="health-score-label">Score</span>
                    </div>
                </div>
                <div class="health-score-info">
                    <h2>Meeting Health Score</h2>
                    <p id="health-score-message" class="health-score-message">Analyzing your meeting patterns...</p>
                    <div id="health-score-trend" class="health-score-trend stable">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14"/>
                        </svg>
                        <span>Calculating trend...</span>
                    </div>
                </div>
            </div>
            
            <div class="health-breakdown" role="list" aria-label="Health Score Breakdown">
                <div class="health-breakdown-item" role="listitem">
                    <p class="health-breakdown-label">Effectiveness</p>
                    <p id="health-effectiveness" class="health-breakdown-value">—</p>
                </div>
                <div class="health-breakdown-item" role="listitem">
                    <p class="health-breakdown-label">Engagement</p>
                    <p id="health-engagement" class="health-breakdown-value">—</p>
                </div>
                <div class="health-breakdown-item" role="listitem">
                    <p class="health-breakdown-label">Follow-through</p>
                    <p id="health-followthrough" class="health-breakdown-value">—</p>
                </div>
                <div class="health-breakdown-item" role="listitem">
                    <p class="health-breakdown-label">Decisions</p>
                    <p id="health-decisions" class="health-breakdown-value">—</p>
                </div>
            </div>
        </div>
    </section>

    <!-- TIER 2: KPI Cards -->
    <section class="tier2-kpi-grid" role="region" aria-label="Key Performance Indicators">
        <article class="kpi-card" data-kpi="meetings" tabindex="0">
            <div class="kpi-header">
                <span class="kpi-label">Total Meetings</span>
                <span id="kpi-meetings-badge" class="kpi-badge neutral">—</span>
            </div>
            <p id="kpi-meetings-value" class="kpi-value">{{ total_meetings|default(0) }}</p>
            <p id="kpi-meetings-comparison" class="kpi-comparison">Loading comparison...</p>
        </article>
        
        <article class="kpi-card" data-kpi="tasks" tabindex="0">
            <div class="kpi-header">
                <span class="kpi-label">Action Items</span>
                <span id="kpi-tasks-badge" class="kpi-badge {% if task_completion_rate|default(0) >= 70 %}up{% elif task_completion_rate|default(0) >= 40 %}neutral{% else %}down{% endif %}">{{ task_completion_rate|default(0) }}%</span>
            </div>
            <p id="kpi-tasks-value" class="kpi-value">{{ total_tasks|default(0) }}</p>
            <p id="kpi-tasks-comparison" class="kpi-comparison">{{ task_completion_rate|default(0) }}% completion rate</p>
        </article>
        
        <article class="kpi-card" data-kpi="hours" tabindex="0">
            <div class="kpi-header">
                <span class="kpi-label">Hours Saved</span>
                <span id="kpi-hours-badge" class="kpi-badge neutral">—</span>
            </div>
            <p id="kpi-hours-value" class="kpi-value">{{ hours_saved|default(0) }}h</p>
            <p id="kpi-hours-comparison" class="kpi-comparison">Through efficient meetings</p>
        </article>
        
        <article class="kpi-card" data-kpi="duration" tabindex="0">
            <div class="kpi-header">
                <span class="kpi-label">Avg Duration</span>
                <span id="kpi-duration-badge" class="kpi-badge neutral">—</span>
            </div>
            <p id="kpi-duration-value" class="kpi-value">{{ avg_duration|default(0) }}m</p>
            <p id="kpi-duration-comparison" class="kpi-comparison">Per meeting average</p>
        </article>
    </section>

    <!-- TIER 2: Actionable Insights -->
    <section class="tier2-actionable-insights" role="region" aria-label="Actionable Insights">
        <div class="section-header">
            <h2 class="section-title">Actionable Insights</h2>
            <span id="insights-count" class="section-badge">Loading...</span>
        </div>
        
        <div id="actionable-insights-container" class="insights-grid" role="feed">
            <div class="insight-card success">
                <div class="insight-icon">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h3 class="insight-title">Task Follow-Through</h3>
                <p id="insight-tasks-desc" class="insight-description">{{ task_completion_rate|default(0) }}% of action items completed on time</p>
            </div>
            
            <div class="insight-card info">
                <div class="insight-icon">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h3 class="insight-title">Meeting Efficiency</h3>
                <p id="insight-efficiency-desc" class="insight-description">Average meeting runs {{ avg_duration|default(45) }} minutes</p>
            </div>
            
            <div class="insight-card action">
                <div class="insight-icon">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <h3 class="insight-title">Recommendations</h3>
                <p id="insight-recommendations-desc" class="insight-description">AI-powered suggestions to improve your meetings</p>
                <span class="insight-action" onclick="document.getElementById('deep-dive-insights').classList.toggle('open')">
                    View Details
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </span>
            </div>
        </div>
    </section>

    <!-- TIER 3: Deep Dive Analytics (Accordion) -->
    <section class="tier3-deep-dive" role="region" aria-label="Detailed Analytics">
        
        <!-- Task Follow-Through (Consolidated) -->
        <div id="deep-dive-tasks" class="deep-dive-section open">
            <div class="deep-dive-header" role="button" tabindex="0" aria-expanded="true">
                <h3>
                    <svg class="icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    Task Follow-Through
                </h3>
                <svg class="deep-dive-toggle" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
            <div class="deep-dive-content">
                <div class="deep-dive-body">
                    <div class="consolidated-chart-grid">
                        <div class="chart-card">
                            <h4>Task Status Distribution</h4>
                            <p class="chart-subtitle">Current breakdown of action items</p>
                            <div class="chart-frame" style="aspect-ratio: 1; max-width: 280px; margin: 0 auto;">
                                <canvas id="taskStatusChart" aria-label="Task status breakdown"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Completion Over Time</h4>
                            <p class="chart-subtitle">Task completion trends</p>
                            <div class="chart-frame" style="aspect-ratio: 16/9;">
                                <canvas id="taskCompletionChart" aria-label="Task completion trend"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Meeting Activity (Consolidated) -->
        <div id="deep-dive-activity" class="deep-dive-section">
            <div class="deep-dive-header" role="button" tabindex="0" aria-expanded="false">
                <h3>
                    <svg class="icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                    </svg>
                    Meeting Activity
                </h3>
                <svg class="deep-dive-toggle" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
            <div class="deep-dive-content">
                <div class="deep-dive-body">
                    <div class="chart-card">
                        <h4>Meeting Frequency</h4>
                        <p class="chart-subtitle">Number of meetings over time</p>
                        <div class="chart-frame" style="aspect-ratio: 21/9;">
                            <canvas id="meetingActivityChart" aria-label="Meeting activity trend"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participation Balance (Consolidated - was 5 separate widgets) -->
        <div id="deep-dive-participation" class="deep-dive-section">
            <div class="deep-dive-header" role="button" tabindex="0" aria-expanded="false">
                <h3>
                    <svg class="icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Participation Balance
                </h3>
                <svg class="deep-dive-toggle" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
            <div class="deep-dive-content">
                <div class="deep-dive-body">
                    <div class="consolidated-chart-grid">
                        <div class="chart-card">
                            <h4>Speaking Distribution</h4>
                            <p class="chart-subtitle">Who contributed to discussions</p>
                            <div class="chart-frame" style="aspect-ratio: 16/9;">
                                <canvas id="speakerChart" aria-label="Speaker distribution"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Engagement Balance</h4>
                            <p class="chart-subtitle">Multi-dimensional participation metrics</p>
                            <div class="chart-frame" style="aspect-ratio: 1; max-width: 300px; margin: 0 auto;">
                                <canvas id="participationChart" aria-label="Participation radar"></canvas>
                            </div>
                        </div>
                    </div>
                    <div id="participant-outliers" class="mt-4" style="display: none;">
                        <!-- Populated dynamically with outlier highlights -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Themes (Consolidated - was 2 separate widgets) -->
        <div id="deep-dive-themes" class="deep-dive-section">
            <div class="deep-dive-header" role="button" tabindex="0" aria-expanded="false">
                <h3>
                    <svg class="icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    Key Themes
                </h3>
                <svg class="deep-dive-toggle" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
            <div class="deep-dive-content">
                <div class="deep-dive-body">
                    <div id="themes-container" class="chart-card">
                        <h4>Top Discussion Topics</h4>
                        <p class="chart-subtitle">Most frequent themes across your meetings</p>
                        <div id="topics-distribution" style="padding: var(--space-4) 0;">
                            <div class="crown5-empty-state" style="min-height: 120px;">
                                <p class="crown5-empty-title" style="font-size: 0.9rem;">Record meetings to see topic analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights & Recommendations -->
        <div id="deep-dive-insights" class="deep-dive-section">
            <div class="deep-dive-header" role="button" tabindex="0" aria-expanded="false">
                <h3>
                    <svg class="icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    AI Insights & Recommendations
                </h3>
                <svg class="deep-dive-toggle" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
            <div class="deep-dive-content">
                <div class="deep-dive-body">
                    <div class="consolidated-chart-grid">
                        <div class="chart-card">
                            <h4>Key Insights</h4>
                            <div id="key-insights-list" style="display: flex; flex-direction: column; gap: var(--space-3); margin-top: var(--space-3);">
                                <div class="p-3 rounded-lg" style="background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e;">
                                    <p class="font-medium text-sm mb-1">High Completion Rate</p>
                                    <p class="text-sm text-secondary">{{ task_completion_rate|default(0) }}% of tasks completed</p>
                                </div>
                                <div class="p-3 rounded-lg" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid #6366f1;">
                                    <p class="font-medium text-sm mb-1">Active Participation</p>
                                    <p class="text-sm text-secondary">Good speaking time distribution</p>
                                </div>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Recommendations</h4>
                            <div id="recommendations-list" style="display: flex; flex-direction: column; gap: var(--space-3); margin-top: var(--space-3);">
                                <div class="flex gap-3 items-start">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(99, 102, 241, 0.1);">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" class="text-primary" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm">Optimize meeting length</p>
                                        <p class="text-sm text-secondary">Consider 25 or 50-minute blocks</p>
                                    </div>
                                </div>
                                <div class="flex gap-3 items-start">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(99, 102, 241, 0.1);">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" class="text-primary" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm">Set task deadlines</p>
                                        <p class="text-sm text-secondary">Improve accountability</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="/static/js/analytics.js" nonce="{{ g.csp_nonce }}"></script>

<script nonce="{{ g.csp_nonce }}">
(function() {
    'use strict';
    
    const WORKSPACE_ID = {{ current_user.workspace_id }};
    const TOTAL_MEETINGS = {{ total_meetings|default(0) }};
    
    // CROWN⁵+ Cache-First Store
    const AnalyticsCache = {
        CACHE_KEY: 'crown5_analytics_v2',
        CACHE_TTL: 30000,
        lastSequenceId: null,
        
        get() {
            try {
                const cached = localStorage.getItem(this.CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (Date.now() - data.timestamp < this.CACHE_TTL) {
                        return data.payload;
                    }
                }
            } catch (e) {}
            return null;
        },
        
        set(payload, sequenceId) {
            try {
                this.lastSequenceId = sequenceId;
                localStorage.setItem(this.CACHE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    sequenceId,
                    payload
                }));
            } catch (e) {}
        }
    };

    // Reconnection with exponential backoff
    const ReconnectionManager = {
        retryCount: 0,
        maxRetries: 8,
        baseDelay: 1000,
        
        getDelay() {
            return Math.min(this.baseDelay * Math.pow(2, this.retryCount), 30000) + Math.random() * 1000;
        },
        
        reset() {
            this.retryCount = 0;
        }
    };

    // Initialize Health Score Ring
    function updateHealthScore(score, message, trend) {
        const arc = document.getElementById('health-score-arc');
        const valueEl = document.getElementById('health-score-value');
        const msgEl = document.getElementById('health-score-message');
        const trendEl = document.getElementById('health-score-trend');
        
        if (arc && score !== null && score !== undefined) {
            const dashArray = `${score}, 100`;
            arc.style.strokeDasharray = dashArray;
        }
        
        if (valueEl) valueEl.textContent = score !== null ? score : '—';
        if (msgEl && message) msgEl.textContent = message;
        
        if (trendEl && trend) {
            trendEl.className = `health-score-trend ${trend.direction || 'stable'}`;
            const icon = trend.direction === 'up' ? 'M5 10l7-7m0 0l7 7m-7-7v18' :
                        trend.direction === 'down' ? 'M19 14l-7 7m0 0l-7-7m7 7V3' :
                        'M5 12h14';
            trendEl.innerHTML = `
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icon}"/>
                </svg>
                <span>${trend.text || 'Stable'}</span>
            `;
        }
    }

    // Update Health Breakdown
    function updateHealthBreakdown(data) {
        const fields = ['effectiveness', 'engagement', 'followthrough', 'decisions'];
        fields.forEach(field => {
            const el = document.getElementById(`health-${field}`);
            if (el && data[field] !== undefined) {
                el.textContent = typeof data[field] === 'number' ? 
                    (field === 'decisions' ? data[field] : `${Math.round(data[field])}%`) : 
                    data[field];
            }
        });
    }

    // Update KPI Cards with animation
    function updateKPI(kpi, value, badge, comparison) {
        const valueEl = document.getElementById(`kpi-${kpi}-value`);
        const badgeEl = document.getElementById(`kpi-${kpi}-badge`);
        const compEl = document.getElementById(`kpi-${kpi}-comparison`);
        
        if (valueEl && value !== undefined) {
            animateValue(valueEl, value);
        }
        
        if (badgeEl && badge) {
            badgeEl.textContent = badge.text;
            badgeEl.className = `kpi-badge ${badge.direction || 'neutral'}`;
        }
        
        if (compEl && comparison) {
            compEl.textContent = comparison;
        }
    }

    function animateValue(element, newValue) {
        const current = parseFloat(element.textContent.replace(/[^0-9.-]/g, '')) || 0;
        const target = parseFloat(newValue);
        const suffix = element.textContent.match(/[a-z%]+$/i)?.[0] || '';
        
        if (isNaN(target)) {
            element.textContent = newValue;
            return;
        }
        
        const duration = 400;
        const start = performance.now();
        
        function update(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            const value = current + (target - current) * eased;
            
            element.textContent = (Number.isInteger(target) ? Math.round(value) : value.toFixed(1)) + suffix;
            
            if (progress < 1) requestAnimationFrame(update);
        }
        
        requestAnimationFrame(update);
    }

    // Fetch and load analytics data
    async function loadAnalyticsData() {
        // Use cache first
        const cached = AnalyticsCache.get();
        if (cached) {
            applyAnalyticsData(cached);
        }

        try {
            const days = document.getElementById('date-range-select')?.value || 30;
            
            const [kpiRes, healthRes] = await Promise.all([
                fetch(`/api/analytics/kpi-comparison?days=${days}`),
                fetch(`/api/analytics/health-score?days=${days}`)
            ]);
            
            const kpiData = await kpiRes.json();
            const healthData = await healthRes.json();
            
            if (kpiData.success) {
                applyKPIData(kpiData);
                AnalyticsCache.set({ kpi: kpiData, health: healthData }, Date.now());
            }
            
            if (healthData.success && healthData.health_score) {
                applyHealthData(healthData.health_score);
            }
            
            // Update insights count
            const insightsCount = document.getElementById('insights-count');
            if (insightsCount) {
                insightsCount.textContent = `${TOTAL_MEETINGS} meetings analyzed`;
            }
            
        } catch (err) {
            console.error('Failed to load analytics:', err);
        }
    }

    function applyAnalyticsData(data) {
        if (data.kpi) applyKPIData(data.kpi);
        if (data.health?.health_score) applyHealthData(data.health.health_score);
    }

    function applyKPIData(data) {
        if (!data.kpis) return;
        
        const { total_meetings, action_items, hours_saved, avg_duration } = data.kpis;
        
        if (total_meetings) {
            updateKPI('meetings', total_meetings.value, 
                { text: total_meetings.change_text || '—', direction: total_meetings.trend },
                total_meetings.comparison_text
            );
        }
        
        if (action_items) {
            updateKPI('tasks', action_items.value,
                { text: `${action_items.completion_rate || 0}%`, direction: action_items.completion_rate >= 70 ? 'up' : 'neutral' },
                `${action_items.completion_rate || 0}% completion rate`
            );
        }
        
        if (hours_saved) {
            updateKPI('hours', hours_saved.value + 'h',
                { text: hours_saved.change_text || '—', direction: hours_saved.trend },
                'Through efficient meetings'
            );
        }
        
        if (avg_duration) {
            updateKPI('duration', avg_duration.value + 'm',
                { text: avg_duration.change_text || '—', direction: avg_duration.trend === 'down' ? 'up' : avg_duration.trend },
                'Per meeting average'
            );
        }
    }

    function applyHealthData(health) {
        updateHealthScore(
            health.overall_score,
            health.message || 'Your meetings are productive',
            { direction: health.trend || 'stable', text: health.trend_text || 'Stable' }
        );
        
        updateHealthBreakdown({
            effectiveness: health.effectiveness_score,
            engagement: health.engagement_score,
            followthrough: health.follow_through_rate,
            decisions: health.decisions_count || '—'
        });
    }

    // WebSocket Integration
    function initWebSocket() {
        if (!window.wsManager) {
            console.warn('WebSocket manager not available');
            return;
        }
        
        window.wsManager.connect('analytics');
        window.wsManager.emit('join', { room: `workspace_${WORKSPACE_ID}` });
        
        window.wsManager.on('analytics_delta', (delta) => {
            if (AnalyticsCache.lastSequenceId && delta.sequence_id <= AnalyticsCache.lastSequenceId) {
                return;
            }
            
            loadAnalyticsData();
            AnalyticsCache.lastSequenceId = delta.sequence_id;
            showUpdateIndicator();
        });
        
        window.wsManager.on('analytics_update', () => {
            loadAnalyticsData();
        });
        
        window.wsManager.on('disconnect', () => {
            setTimeout(() => initWebSocket(), ReconnectionManager.getDelay());
            ReconnectionManager.retryCount++;
        });
        
        window.wsManager.on('connect', () => {
            ReconnectionManager.reset();
        });
    }

    function showUpdateIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'fixed top-20 right-4 px-4 py-2 rounded-lg text-sm font-medium z-50';
        indicator.style.cssText = 'background: rgba(99, 102, 241, 0.9); color: white; animation: crownFadeIn 0.3s ease-out;';
        indicator.textContent = 'Analytics updated';
        document.body.appendChild(indicator);
        
        setTimeout(() => {
            indicator.style.opacity = '0';
            indicator.style.transition = 'opacity 0.3s ease';
            setTimeout(() => indicator.remove(), 300);
        }, 2000);
    }

    // Date range change handler
    document.getElementById('date-range-select')?.addEventListener('change', () => {
        AnalyticsCache.set(null, null);
        loadAnalyticsData();
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadAnalyticsData();
        initWebSocket();
        
        // Open first accordion by default
        const firstSection = document.querySelector('.deep-dive-section');
        if (firstSection) firstSection.classList.add('open');
    });
    
    // Expose for analytics.js integration
    window.analyticsManager = {
        loadDashboardData: loadAnalyticsData,
        updateMeetingHealthScore: applyHealthData
    };
    
})();
</script>
{% endblock %}
